import{r as c,j as r,b as s}from"./index-f6ac47b8.js";import{A as U}from"./AsciiButton-4907e65e.js";import{S as $,F as B,E as G,A as N,G as M}from"./GCSConnectionConfig-f004c48c.js";const J=["S3","FTP","SFTP","Email","AzureBlob","GCS"],X=(o,n)=>{if(!o)return null;try{if(n==="S3"){const e=new URLSearchParams(o);return{access_key_id:e.get("access_key_id")||"",secret_access_key:e.get("secret_access_key")||"",region:e.get("region")||"us-east-1",bucket_name:e.get("bucket_name")||"",endpoint:e.get("endpoint")||"",use_ssl:e.get("use_ssl")!=="false"}}else if(n==="FTP"||n==="SFTP"){const e=new URLSearchParams(o);return{protocol:n==="SFTP"?"SFTP":"FTP",host:e.get("host")||"",port:parseInt(e.get("port")||(n==="SFTP"?"22":"21")),username:e.get("username")||"",password:e.get("password")||"",remote_path:e.get("remote_path")||"/",use_passive:e.get("use_passive")!=="false",use_ssl:e.get("use_ssl")==="true"}}else if(n==="Email"){const e=new URLSearchParams(o);return{protocol:e.get("protocol")==="POP3"?"POP3":"IMAP",server:e.get("server")||"",port:parseInt(e.get("port")||"993"),username:e.get("username")||"",password:e.get("password")||"",folder:e.get("folder")||"INBOX",use_ssl:e.get("use_ssl")!=="false",max_emails:parseInt(e.get("max_emails")||"100"),download_attachments:e.get("download_attachments")==="true"}}else if(n==="AzureBlob"){const e=new URLSearchParams(o);return{account_name:e.get("account_name")||"",account_key:e.get("account_key")||"",container_name:e.get("container_name")||"",endpoint_suffix:e.get("endpoint_suffix")||"core.windows.net",use_https:e.get("use_https")!=="false"}}else if(n==="GCS"){const e=new URLSearchParams(o);return{project_id:e.get("project_id")||"",credentials_json:e.get("credentials_json")||"",bucket_name:e.get("bucket_name")||"",use_https:e.get("use_https")!=="false"}}}catch(e){console.error("Error parsing connection string:",e)}return null},v=(o,n)=>{if(!o)return"";const e=new URLSearchParams;return Object.entries(o).forEach(([i,m])=>{m!=null&&m!==""&&e.set(i,String(m))}),e.toString()},W=({value:o,onChange:n,dbEngine:e,label:i,required:m=!1,onTestConnection:l,isTesting:u=!1,testResult:_,placeholder:I="Enter connection string..."})=>{const[p,P]=c.useState([]),[j,F]=c.useState(!1),[C,x]=c.useState(!1),a=c.useMemo(()=>J.includes(e),[e]),k=c.useMemo(()=>!a||!o?null:X(o,e),[o,e,a]),h=c.useMemo(()=>a?e==="S3"?{access_key_id:"",secret_access_key:"",region:"us-east-1",bucket_name:"",endpoint:"",use_ssl:!0}:e==="FTP"||e==="SFTP"?{protocol:e==="SFTP"?"SFTP":"FTP",host:"",port:e==="SFTP"?22:21,username:"",password:"",remote_path:"/",use_passive:!0,use_ssl:e==="SFTP"}:e==="Email"?{protocol:"IMAP",server:"",port:993,username:"",password:"",folder:"INBOX",use_ssl:!0,max_emails:100,download_attachments:!1}:e==="AzureBlob"?{account_name:"",account_key:"",container_name:"",endpoint_suffix:"core.windows.net",use_https:!0}:e==="GCS"?{project_id:"",credentials_json:"",bucket_name:"",use_https:!0}:null:null,[e,a]),[f,w]=c.useState(h),S=c.useRef({});c.useEffect(()=>{if(a){const t=k||h;if(JSON.stringify(t)!==JSON.stringify(f)&&w(t),!k&&h&&!o&&!S.current[e]){const d=v(h);d&&(S.current[e]=!0,n(d))}e&&!S.current[e]&&o&&(S.current[e]=!0)}else w(null),e&&delete S.current[e]},[a,k,h,e,o]);const g=t=>{w(t);const d=v(t);n(d)},T=c.useCallback(async()=>{if(e){F(!0);try{const t=localStorage.getItem("authToken"),d=`/api/connections?db_engine=${encodeURIComponent(e)}`,y=await fetch(d,{headers:{...t&&{Authorization:`Bearer ${t}`}}});if(y.ok){const O=(await y.json()).connections||[];P(O)}else{const z=await y.text();console.error(`[AsciiConnectionStringSelector:${i}] fetchConnections - Error response:`,y.status,z)}}catch(t){console.error(`[AsciiConnectionStringSelector:${i}] fetchConnections - Exception:`,t)}finally{F(!1)}}},[e,i]);c.useEffect(()=>{a?(P([]),x(!0)):e?T():(P([]),x(!1))},[e,T,i,a]),c.useEffect(()=>{p.length>0},[o,p,i,C]);const b=t=>{t.target.value==="__custom__"?(x(!0),n("")):(x(!1),n(t.target.value))},L=t=>{n(t.target.value)},A=!a&&p.length>0&&!j&&!C,R=!a&&(C||p.length===0&&!j);return r.jsxs("div",{style:{marginBottom:16},children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[r.jsxs("label",{style:{display:"block",fontSize:12,fontWeight:600,color:s.foreground,fontFamily:"Consolas"},children:[i," ",m&&"*"]}),l&&r.jsx(U,{label:u?"Testing...":"Test Connection",onClick:l,variant:"ghost",disabled:u||!e||!o.trim()})]}),j&&r.jsx("div",{style:{fontSize:11,color:s.muted,fontStyle:"italic",marginBottom:8,fontFamily:"Consolas"},children:"Loading available connections..."}),A&&r.jsxs("select",{value:p.some(t=>t.connection_string===o)?o:"",onChange:b,style:{width:"100%",padding:"8px 12px",marginBottom:8,border:`1px solid ${s.border}`,borderRadius:2,fontSize:12,fontFamily:"Consolas",backgroundColor:s.background,color:s.foreground,cursor:"pointer",outline:"none"},onFocus:t=>{t.currentTarget.style.borderColor=s.accent},onBlur:t=>{t.currentTarget.style.borderColor=s.border},children:[r.jsx("option",{value:"",children:"-- Select existing connection --"}),p.map((t,d)=>r.jsx("option",{value:t.connection_string,children:t.connection_string_masked},d)),r.jsx("option",{value:"__custom__",children:"+ Add new connection..."})]}),R&&!a&&r.jsx("textarea",{value:o,onChange:L,placeholder:I,rows:2,style:{width:"100%",padding:"8px 12px",border:`1px solid ${s.border}`,borderRadius:2,fontSize:12,fontFamily:"Consolas",backgroundColor:s.background,color:s.foreground,outline:"none",resize:"vertical",minHeight:"60px"},onFocus:t=>{t.currentTarget.style.borderColor=s.accent},onBlur:t=>{t.currentTarget.style.borderColor=s.border}}),a&&f&&r.jsxs("div",{style:{border:`1px solid ${s.border}`,borderRadius:2,padding:12,backgroundColor:s.backgroundSoft},children:[e==="S3"&&r.jsx($,{config:f,onChange:g,onTest:l,isTesting:u}),e==="FTP"&&r.jsx(B,{config:f,onChange:g,onTest:l,isTesting:u}),e==="SFTP"&&r.jsx(B,{config:{...f,protocol:"SFTP"},onChange:g,onTest:l,isTesting:u}),e==="Email"&&r.jsx(G,{config:f,onChange:g,onTest:l,isTesting:u}),e==="AzureBlob"&&r.jsx(N,{config:f,onChange:g,onTest:l,isTesting:u}),e==="GCS"&&r.jsx(M,{config:f,onChange:g,onTest:l,isTesting:u})]}),!C&&p.length>0&&A&&r.jsx("div",{style:{marginTop:4,fontSize:11,color:s.muted,fontFamily:"Consolas"},children:"Or select an existing connection above"}),_&&r.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:2,fontSize:12,fontFamily:"Consolas",backgroundColor:_.success?s.success+"20":s.danger+"20",border:`1px solid ${_.success?s.success:s.danger}`,color:_.success?s.success:s.danger},children:[_.success?"✓ ":"✗ ",_.message]})]})};export{W as A};
