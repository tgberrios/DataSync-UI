import{r as c,j as o,t as n,b as e,e as b,f as z,ad as R,C as D}from"./index-b1fa964d.js";import{S as Y}from"./SkeletonLoader-09c12074.js";import{e as P}from"./errorHandler-5ea9ae85.js";import{A}from"./AsciiPanel-3399d5be.js";import{A as _}from"./AsciiButton-3fcfdd9b.js";const N=({policies:m,onEdit:k,onDelete:S})=>{const[E,x]=c.useState(new Set),[L,T]=c.useState(new Set),$=c.useMemo(()=>{const r=new Map;return m.forEach(g=>{const a=g.schema_name||"Other",u=g.table_name||"Other";r.has(a)||r.set(a,{name:a,tables:new Map});const l=r.get(a);l.tables.has(u)||l.tables.set(u,{name:u,policies:[]}),l.tables.get(u).policies.push(g)}),Array.from(r.values()).sort((g,a)=>g.name.localeCompare(a.name))},[m]),h=r=>{x(g=>{const a=new Set(g);if(a.has(r)){a.delete(r);const u=$.find(l=>l.name===r);u&&u.tables.forEach(l=>{const C=`${r}.${l.name}`;T(j=>{const p=new Set(j);return p.delete(C),p})})}else a.add(r);return a})},i=(r,g)=>{const a=`${r}.${g}`;T(u=>{const l=new Set(u);return l.has(a)?l.delete(a):l.add(a),l})},y=(r,g)=>{if(r===0)return null;const a=[];for(let u=0;u<r-1;u++)a.push(`${b.v}  `);return g?a.push(`${b.bl}${b.h}${b.h} `):a.push(`${b.tRight}${b.h}${b.h} `),o.jsx("span",{style:{color:e.border,marginRight:6,fontFamily:"Consolas",fontSize:11},children:a.join("")})};return m.length===0?o.jsx("div",{style:{padding:n.spacing.lg,textAlign:"center",color:e.muted,fontFamily:"Consolas",fontSize:12},children:"No RLS policies found. Create one to get started."}):o.jsx("div",{style:{fontFamily:"Consolas",fontSize:12,color:e.foreground},children:$.map((r,g)=>{const a=E.has(r.name),u=Array.from(r.tables.values());return $.length-1,o.jsxs("div",{style:{marginBottom:4},children:[o.jsxs("div",{onClick:()=>h(r.name),style:{display:"flex",alignItems:"center",padding:"10px 8px",cursor:"pointer",borderLeft:`2px solid ${e.accent}`,backgroundColor:a?e.backgroundSoft:e.background,transition:"all 0.15s ease",marginBottom:2},onMouseEnter:l=>{l.currentTarget.style.backgroundColor=e.backgroundSoft},onMouseLeave:l=>{a||(l.currentTarget.style.backgroundColor=e.background)},children:[o.jsx("span",{style:{marginRight:8,color:a?e.accent:e.muted,fontSize:10,transition:"transform 0.15s ease",display:"inline-block",transform:a?"rotate(90deg)":"rotate(0deg)"},children:b.arrowRight}),o.jsx("span",{style:{fontWeight:600,color:e.accent,fontSize:12,flex:1},children:r.name}),o.jsx("span",{style:{padding:"2px 8px",borderRadius:2,fontSize:10,fontWeight:500,border:`1px solid ${e.border}`,backgroundColor:e.backgroundSoft,color:e.foreground},children:u.reduce((l,C)=>l+C.policies.length,0)})]}),a&&o.jsx("div",{style:{paddingLeft:24},children:u.map((l,C)=>{const j=`${r.name}.${l.name}`,p=L.has(j),B=C===u.length-1;return o.jsxs("div",{children:[o.jsxs("div",{onClick:()=>i(r.name,l.name),style:{display:"flex",alignItems:"center",padding:"8px 8px",marginLeft:8,marginBottom:2,borderLeft:`2px solid ${e.border}`,backgroundColor:p?e.backgroundSoft:"transparent",transition:"all 0.15s ease",cursor:"pointer"},onMouseEnter:d=>{d.currentTarget.style.backgroundColor=e.backgroundSoft,d.currentTarget.style.borderLeftColor=e.accent},onMouseLeave:d=>{p||(d.currentTarget.style.backgroundColor="transparent",d.currentTarget.style.borderLeftColor=e.border)},children:[y(1,B),o.jsx("span",{style:{marginRight:8,color:p?e.accent:e.muted,fontSize:10,transition:"transform 0.15s ease",display:"inline-block",transform:p?"rotate(90deg)":"rotate(0deg)"},children:b.arrowRight}),o.jsx("span",{style:{fontWeight:600,color:e.foreground,fontSize:11,flex:1},children:l.name}),o.jsx("span",{style:{padding:"2px 6px",borderRadius:2,fontSize:10,fontWeight:500,border:`1px solid ${e.border}`,backgroundColor:"transparent",color:e.muted},children:l.policies.length})]}),p&&o.jsx("div",{style:{paddingLeft:24},children:l.policies.map((d,w)=>{const F=w===l.policies.length-1;return o.jsxs("div",{style:{display:"flex",alignItems:"flex-start",padding:"8px 8px",marginLeft:8,marginBottom:2,borderLeft:`1px solid ${e.border}`,backgroundColor:"transparent",transition:"all 0.15s ease"},onMouseEnter:f=>{f.currentTarget.style.backgroundColor=e.backgroundSoft,f.currentTarget.style.borderLeftColor=e.accent},onMouseLeave:f=>{f.currentTarget.style.backgroundColor="transparent",f.currentTarget.style.borderLeftColor=e.border},children:[y(2,F),o.jsxs("div",{style:{flex:1,minWidth:0},children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[o.jsx("span",{style:{fontWeight:600,color:e.foreground,fontSize:11},children:d.policy_name}),o.jsx("span",{style:{padding:"2px 6px",borderRadius:2,fontSize:10,fontWeight:500,border:`1px solid ${e.accent}`,color:e.accent,backgroundColor:"transparent"},children:d.policy_type}),o.jsx("span",{style:{padding:"2px 6px",borderRadius:2,fontSize:10,fontWeight:500,border:`1px solid ${d.active?e.accent:e.muted}`,color:d.active?e.accent:e.muted,backgroundColor:"transparent"},children:d.active?"ACTIVE":"INACTIVE"})]}),o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4},children:"Expression:"}),o.jsx("code",{style:{color:e.foreground,fontSize:10,fontFamily:"Consolas",display:"block",padding:"4px 8px",backgroundColor:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,wordBreak:"break-word",whiteSpace:"pre-wrap"},children:d.policy_expression})]}),o.jsxs("div",{style:{display:"flex",gap:4,marginLeft:8},children:[o.jsx(_,{label:"Edit",onClick:f=>{f.stopPropagation(),k==null||k(d)},variant:"ghost",style:{fontSize:10,padding:"2px 6px"}}),d.policy_id&&o.jsx(_,{label:"Delete",onClick:f=>{f.stopPropagation(),S==null||S(d.policy_id)},variant:"ghost",style:{fontSize:10,padding:"2px 6px"}})]})]},d.policy_id||w)})})]},j)})})]},r.name)})})};z.table`
  width: 100%;
  border-collapse: collapse;
  margin-top: ${n.spacing.lg};
  background: ${e.background};
  border-radius: 2;
  overflow: hidden;
  font-family: 'Consolas';
`;z.th`
  padding: ${n.spacing.sm};
  text-align: left;
  border-bottom: 2px solid ${e.border};
  background: ${e.backgroundSoft};
  font-weight: 600;
  font-family: 'Consolas';
  font-size: 13px;
  color: ${e.accent};
  position: sticky;
  top: 0;
  z-index: 10;
`;z.td`
  padding: ${n.spacing.sm};
  border-bottom: 1px solid ${e.border};
  font-family: 'Consolas';
  font-size: 12px;
  transition: background-color 0.15s ease;
  word-break: break-word;
`;z.tr`
  transition: background-color 0.15s ease;
`;const q=()=>{const m=c.useRef(!0),[k,S]=c.useState(!0),[E,x]=c.useState(null),[L,T]=c.useState([]),[$,h]=c.useState(!1),[i,y]=c.useState(null),[r,g]=c.useState({schema_name:"",table_name:"",active:""}),[a,u]=c.useState(1),[l,C]=c.useState(0),j=20,p=c.useCallback(async()=>{if(!m.current)return;const t=Date.now(),s=300;try{S(!0),x(null);const v={page:a,limit:j};r.schema_name&&(v.schema_name=r.schema_name),r.table_name&&(v.table_name=r.table_name),r.active!==""&&(v.active=r.active==="true");const I=await R.getAll(v),O=Date.now()-t,W=Math.max(0,s-O);await new Promise(M=>setTimeout(M,W)),m.current&&(T(I.policies||[]),C(I.total||0))}catch(v){m.current&&x(P(v))}finally{m.current&&S(!1)}},[a,r]);c.useEffect(()=>(m.current=!0,p(),()=>{m.current=!1}),[p]);const B=c.useCallback(()=>{y({policy_name:"",schema_name:"",table_name:"",policy_expression:"",policy_type:"SELECT",description:"",active:!0}),h(!0)},[]),d=c.useCallback(t=>{y({...t}),h(!0)},[]),w=c.useCallback(async t=>{if(confirm("Are you sure you want to delete this RLS policy?"))try{await R.delete(t),p()}catch(s){m.current&&x(P(s))}},[p]),F=c.useCallback(async()=>{if(i)try{x(null),i.policy_id?await R.update(i.policy_id,i):await R.create(i),h(!1),p()}catch(t){m.current&&x(P(t))}},[i,p]),f={SELECT:"user_id = current_setting('app.user_id')::integer",INSERT:"user_id = current_setting('app.user_id')::integer",UPDATE:"user_id = current_setting('app.user_id')::integer",DELETE:"user_id = current_setting('app.user_id')::integer",ALL:"user_id = current_setting('app.user_id')::integer"};return k&&L.length===0?o.jsx(Y,{variant:"table"}):o.jsxs(D,{children:[o.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:n.spacing.lg,paddingBottom:n.spacing.md,borderBottom:`2px solid ${e.accent}`},children:o.jsxs("h1",{style:{fontSize:14,fontWeight:600,margin:0,color:e.foreground,textTransform:"uppercase",fontFamily:"Consolas"},children:[o.jsx("span",{style:{color:e.accent,marginRight:n.spacing.sm},children:b.blockFull}),"ROW-LEVEL SECURITY"]})}),E&&o.jsx("div",{style:{marginBottom:n.spacing.md},children:o.jsx(A,{title:"ERROR",children:o.jsx("div",{style:{padding:n.spacing.sm,color:e.foreground,fontSize:12,fontFamily:"Consolas",backgroundColor:e.backgroundSoft,borderRadius:2},children:E})})}),o.jsx("div",{style:{marginBottom:n.spacing.md},children:o.jsx(A,{title:"ROW-LEVEL SECURITY (RLS)",children:o.jsxs("div",{style:{padding:n.spacing.md,fontFamily:"Consolas",fontSize:12},children:[o.jsx("div",{style:{marginBottom:n.spacing.md},children:o.jsx(_,{label:`${b.blockFull} Create RLS Policy`,onClick:B})}),o.jsxs("div",{style:{marginBottom:n.spacing.md,display:"flex",gap:n.spacing.sm,flexWrap:"wrap"},children:[o.jsx("input",{type:"text",placeholder:"Schema name",value:r.schema_name,onChange:t=>g(s=>({...s,schema_name:t.target.value})),style:{padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,flex:1,minWidth:150,outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}}),o.jsx("input",{type:"text",placeholder:"Table name",value:r.table_name,onChange:t=>g(s=>({...s,table_name:t.target.value})),style:{padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,flex:1,minWidth:150,outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}}),o.jsxs("select",{value:r.active,onChange:t=>g(s=>({...s,active:t.target.value})),style:{padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,minWidth:120,outline:"none",transition:"border-color 0.15s ease",cursor:"pointer"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"},children:[o.jsx("option",{value:"",children:"All Status"}),o.jsx("option",{value:"true",children:"Active"}),o.jsx("option",{value:"false",children:"Inactive"})]})]}),o.jsxs("div",{style:{marginBottom:n.spacing.sm,fontSize:11,color:e.muted,fontFamily:"Consolas"},children:["RLS Policies (",l,")"]}),o.jsx(N,{policies:L,onEdit:d,onDelete:w})]})})}),$&&i&&o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:20},onClick:t=>{t.target===t.currentTarget&&h(!1)},children:o.jsxs("div",{style:{backgroundColor:e.background,border:`2px solid ${e.border}`,borderRadius:2,width:"90%",maxWidth:700,maxHeight:"90vh",overflowY:"auto"},onClick:t=>t.stopPropagation(),children:[o.jsx("style",{children:`
              div[style*="overflowY"]::-webkit-scrollbar {
                width: 0px;
                display: none;
              }
              div[style*="overflowY"] {
                -ms-overflow-style: none;
                scrollbar-width: none;
              }
            `}),o.jsx(A,{title:i.policy_id?"EDIT RLS POLICY":"CREATE RLS POLICY",children:o.jsxs("div",{style:{padding:n.spacing.md,fontFamily:"Consolas",fontSize:12},children:[o.jsxs("div",{style:{marginBottom:n.spacing.md},children:[o.jsx("label",{style:{display:"block",marginBottom:n.spacing.xs,color:e.muted,fontSize:11,fontFamily:"Consolas"},children:"Policy Name *"}),o.jsx("input",{type:"text",value:i.policy_name,onChange:t=>y(s=>s?{...s,policy_name:t.target.value}:null),style:{width:"100%",padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}})]}),o.jsxs("div",{style:{marginBottom:n.spacing.md},children:[o.jsx("label",{style:{display:"block",marginBottom:n.spacing.xs,color:e.muted,fontSize:11,fontFamily:"Consolas"},children:"Schema Name *"}),o.jsx("input",{type:"text",value:i.schema_name,onChange:t=>y(s=>s?{...s,schema_name:t.target.value}:null),style:{width:"100%",padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}})]}),o.jsxs("div",{style:{marginBottom:n.spacing.md},children:[o.jsx("label",{style:{display:"block",marginBottom:n.spacing.xs,color:e.muted,fontSize:11,fontFamily:"Consolas"},children:"Table Name *"}),o.jsx("input",{type:"text",value:i.table_name,onChange:t=>y(s=>s?{...s,table_name:t.target.value}:null),style:{width:"100%",padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}})]}),o.jsxs("div",{style:{marginBottom:n.spacing.md},children:[o.jsx("label",{style:{display:"block",marginBottom:n.spacing.xs,color:e.muted,fontSize:11,fontFamily:"Consolas"},children:"Policy Type *"}),o.jsxs("select",{value:i.policy_type,onChange:t=>y(s=>s?{...s,policy_type:t.target.value}:null),style:{width:"100%",padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,outline:"none",transition:"border-color 0.15s ease",cursor:"pointer"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"},children:[o.jsx("option",{value:"SELECT",children:"SELECT"}),o.jsx("option",{value:"INSERT",children:"INSERT"}),o.jsx("option",{value:"UPDATE",children:"UPDATE"}),o.jsx("option",{value:"DELETE",children:"DELETE"}),o.jsx("option",{value:"ALL",children:"ALL"})]})]}),o.jsxs("div",{style:{marginBottom:n.spacing.md},children:[o.jsx("label",{style:{display:"block",marginBottom:n.spacing.xs,color:e.muted,fontSize:11,fontFamily:"Consolas"},children:"Policy Expression (SQL) *"}),o.jsx("textarea",{value:i.policy_expression,onChange:t=>y(s=>s?{...s,policy_expression:t.target.value}:null),placeholder:f[i.policy_type],rows:4,style:{width:"100%",padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,resize:"vertical",outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}}),o.jsx("div",{style:{marginTop:n.spacing.xs,fontSize:10,color:e.muted,fontFamily:"Consolas"},children:"Example: user_id = current_setting('app.user_id')::integer"})]}),o.jsxs("div",{style:{marginBottom:n.spacing.md},children:[o.jsx("label",{style:{display:"block",marginBottom:n.spacing.xs,color:e.muted,fontSize:11,fontFamily:"Consolas"},children:"Description"}),o.jsx("textarea",{value:i.description||"",onChange:t=>y(s=>s?{...s,description:t.target.value}:null),rows:2,style:{width:"100%",padding:`${n.spacing.sm} ${n.spacing.md}`,border:`1px solid ${e.border}`,backgroundColor:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,borderRadius:2,resize:"vertical",outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}})]}),o.jsx("div",{style:{marginBottom:n.spacing.md},children:o.jsxs("label",{style:{display:"flex",alignItems:"center",gap:n.spacing.sm,cursor:"pointer"},children:[o.jsx("input",{type:"checkbox",checked:i.active,onChange:t=>y(s=>s?{...s,active:t.target.checked}:null),style:{cursor:"pointer"}}),o.jsx("span",{style:{color:e.foreground,fontSize:12,fontFamily:"Consolas"},children:"Active"})]})}),o.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:n.spacing.sm,marginTop:n.spacing.lg},children:[o.jsx(_,{label:"Cancel",onClick:()=>h(!1),variant:"ghost"}),o.jsx(_,{label:"Save",onClick:F})]})]})})]})})]})};export{q as default};
