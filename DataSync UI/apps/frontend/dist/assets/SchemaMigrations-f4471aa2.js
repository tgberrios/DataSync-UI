import{j as o,b as e,e as b,t as s,r,aa as Z,ab as z,C as J}from"./index-b1fa964d.js";import{A as ee}from"./AsciiButton-3fcfdd9b.js";import{S as oe}from"./SkeletonLoader-09c12074.js";import{u as ne}from"./usePagination-05d2e222.js";import{u as te}from"./useTableFilters-34614e65.js";import{e as T}from"./errorHandler-5ea9ae85.js";import{s as se}from"./validation-24839588.js";import{A as q}from"./AsciiPanel-3399d5be.js";import{C as re}from"./ConnectionStringSelector-fd4a99d4.js";import"./GCSConnectionConfig-e2d15d83.js";const ie=a=>{switch(a){case"APPLIED":return"âœ“";case"PENDING":return"â³";case"FAILED":return"âœ—";case"ROLLED_BACK":return"â†©";default:return"?"}},le=({migrations:a,loading:v,onViewMigration:n,onApplyMigration:c,onRollbackMigration:j,onTestMigration:l})=>v?o.jsxs("div",{style:{padding:40,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:[b.blockSemi," Loading migrations..."]}):a.length===0?o.jsxs("div",{style:{padding:40,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:[b.blockSemi," No migrations found. Create your first migration to get started."]}):o.jsx("div",{style:{border:`1px solid ${e.border}`,borderRadius:2,background:e.background,maxHeight:"70vh",overflowX:"auto",overflowY:"auto"},children:o.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontFamily:"Consolas",fontSize:12},children:[o.jsx("thead",{children:o.jsxs("tr",{style:{background:e.backgroundSoft,borderBottom:`2px solid ${e.border}`},children:[o.jsx("th",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"left",fontWeight:600,color:e.foreground},children:"Migration"}),o.jsx("th",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"left",fontWeight:600,color:e.foreground},children:"Version"}),o.jsx("th",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"left",fontWeight:600,color:e.foreground},children:"DB Engine"}),o.jsx("th",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"left",fontWeight:600,color:e.foreground},children:"Status"}),o.jsx("th",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"left",fontWeight:600,color:e.foreground},children:"Created"}),o.jsx("th",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"left",fontWeight:600,color:e.foreground},children:"Last applied"}),o.jsx("th",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"right",fontWeight:600,color:e.foreground},children:"Actions"})]})}),o.jsx("tbody",{children:a.map(d=>o.jsxs("tr",{style:{borderBottom:`1px solid ${e.border}`,transition:"background 0.15s ease"},onMouseEnter:m=>{m.currentTarget.style.background=e.backgroundSoft},onMouseLeave:m=>{m.currentTarget.style.background="transparent"},children:[o.jsx("td",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,color:e.foreground,fontWeight:600},children:d.migration_name}),o.jsx("td",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,color:e.muted},children:d.version}),o.jsx("td",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,color:e.foreground},children:d.db_engine||"N/A"}),o.jsx("td",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`},children:o.jsxs("span",{style:{padding:"4px 8px",borderRadius:2,fontSize:10,fontWeight:600,background:"transparent",color:e.foreground,fontFamily:"Consolas",border:`1px solid ${e.border}`},children:[ie(d.status)," ",d.status]})}),o.jsx("td",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,color:e.muted,fontSize:11},children:new Date(d.created_at).toLocaleString()}),o.jsx("td",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,color:e.muted,fontSize:11},children:d.last_applied_at?new Date(d.last_applied_at).toLocaleString():"â€”"}),o.jsx("td",{style:{padding:`${s.spacing.sm} ${s.spacing.md}`,textAlign:"right"},children:o.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",flexWrap:"wrap"},children:[o.jsx("button",{onClick:()=>n(d),style:{padding:"4px 8px",border:`1px solid ${e.border}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:10,fontFamily:"Consolas",fontWeight:600},children:"VIEW"}),l&&o.jsx("button",{onClick:()=>l(d),style:{padding:"4px 8px",border:`1px solid ${e.accent}`,borderRadius:2,background:"transparent",color:e.accent,cursor:"pointer",fontSize:10,fontFamily:"Consolas",fontWeight:600},children:"TEST"}),d.status!=="APPLIED"&&o.jsx("button",{onClick:()=>{const m=prompt("Enter environment (dev/staging/qa/production):");m&&c(d.migration_name,m)},style:{padding:"4px 8px",border:`1px solid ${e.border}`,borderRadius:2,background:"transparent",color:e.foreground,cursor:"pointer",fontSize:10,fontFamily:"Consolas",fontWeight:600},children:"APPLY"}),d.status==="APPLIED"&&o.jsx("button",{onClick:()=>{const m=prompt("Enter environment (dev/staging/qa/production):");m&&j(d.migration_name,m)},style:{padding:"4px 8px",border:`1px solid ${e.border}`,borderRadius:2,background:"transparent",color:e.foreground,cursor:"pointer",fontSize:10,fontFamily:"Consolas",fontWeight:600},children:"ROLLBACK"})]})})]},d.migration_name))})]})}),Q=a=>{switch(a){case"PostgreSQL":return"postgresql://username:password@localhost:5432/database_name";case"MariaDB":return"mysql://username:password@localhost:3306/database_name";case"MSSQL":return"mssql://username:password@localhost:1433/database_name";case"MongoDB":return"mongodb://username:password@localhost:27017/database_name?authSource=admin";case"Oracle":return"oracle://username:password@localhost:1521/XE";default:return"postgresql://username:password@localhost:5432/database_name"}},ae=({onClose:a,onSuccess:v})=>{const[n,c]=r.useState({migration_name:"",version:"",description:"",db_engine:"PostgreSQL",forward_sql:"",rollback_sql:"",environment_connections:{dev:"",staging:"",qa:"",production:Q("PostgreSQL")}}),[j,l]=r.useState(null),[d,m]=r.useState(!1),[k,y]=r.useState({env:"",testing:!1}),[_,E]=r.useState(!1),[A,p]=r.useState({}),[h,C]=r.useState(null),[R,D]=r.useState("production");r.useEffect(()=>{const i=Q(n.db_engine),x=["postgresql://username:password@localhost:5432/database_name","mysql://username:password@localhost:3306/database_name","mssql://username:password@localhost:1433/database_name","mongodb://username:password@localhost:27017/database_name?authSource=admin","oracle://username:password@localhost:1521/XE"];c(g=>{const S={...g.environment_connections};return(!S.production||x.includes(S.production))&&(S.production=i),{...g,environment_connections:S}})},[n.db_engine]);const u=async i=>{const x=n.environment_connections[i];if(!x||x.trim()===""){p(g=>({...g,[i]:{success:!1,message:"Connection string is required"}}));return}y({env:i,testing:!0}),p(g=>({...g,[i]:null})),l(null);try{await Z.testConnection(n.db_engine,x),p(g=>({...g,[i]:{success:!0,message:"Connection successful!"}}))}catch(g){p(S=>({...S,[i]:{success:!1,message:T(g)}}))}finally{y({env:"",testing:!1})}},f=async()=>{var x;if(!n.forward_sql||n.forward_sql.trim()===""){C({success:!1,message:"Forward SQL is required"});return}if(!n.rollback_sql||n.rollback_sql.trim()===""){C({success:!1,message:"Rollback SQL is required"});return}const i=n.environment_connections[R];if(!i||i.trim()===""){C({success:!1,message:`Connection string for ${R} is required`});return}E(!0),C(null),l(null);try{const g=await z.testSQL({db_engine:n.db_engine,connection_string:i,forward_sql:n.forward_sql,rollback_sql:n.rollback_sql});C({success:g.success,message:g.message||(g.success?"SQL test successful! Forward and rollback executed correctly.":((x=g.errors)==null?void 0:x.join("; "))||"SQL test failed")})}catch(g){C({success:!1,message:T(g)})}finally{E(!1)}},B=async i=>{if(i.preventDefault(),l(null),!n.migration_name||!n.version||!n.forward_sql){l("Migration name, version, and forward SQL are required");return}if(!n.rollback_sql||n.rollback_sql.trim()===""){l("Rollback SQL is MANDATORY. Every migration must have a rollback strategy.");return}if(!n.environment_connections.production||n.environment_connections.production.trim()===""){l("Production Connection String is MANDATORY.");return}m(!0);try{const x={};Object.entries(n.environment_connections).forEach(([g,S])=>{S&&S.trim()!==""&&(x[g]=S.trim())}),await z.create({...n,environment_connections:x}),v()}catch(x){l(T(x))}finally{m(!1)}};return o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:o.jsx("div",{style:{width:"90%",maxWidth:800,maxHeight:"90vh",overflowY:"auto"},children:o.jsxs(q,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${e.border}`},children:[o.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:e.accent,margin:0,fontFamily:"Consolas"},children:[b.blockFull," CREATE MIGRATION"]}),o.jsx("button",{onClick:a,style:{background:"transparent",border:"none",color:e.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),o.jsx("form",{onSubmit:B,children:o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16},children:[o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Migration Name *"}),o.jsx("input",{type:"text",value:n.migration_name,onChange:i=>c({...n,migration_name:i.target.value}),placeholder:"e.g., add_user_email_column",style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12}})]}),o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Version *"}),o.jsx("input",{type:"text",value:n.version,onChange:i=>c({...n,version:i.target.value}),placeholder:"e.g., 1.0.0",style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"DB Engine"}),o.jsxs("select",{value:n.db_engine,onChange:i=>c({...n,db_engine:i.target.value}),style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer"},children:[o.jsx("option",{value:"PostgreSQL",children:"PostgreSQL"}),o.jsx("option",{value:"MariaDB",children:"MariaDB"}),o.jsx("option",{value:"MSSQL",children:"MSSQL"}),o.jsx("option",{value:"Oracle",children:"Oracle"}),o.jsx("option",{value:"MongoDB",children:"MongoDB"})]})]})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Description"}),o.jsx("textarea",{value:n.description,onChange:i=>c({...n,description:i.target.value}),placeholder:"Describe what this migration does...",rows:3,style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12,resize:"vertical"}})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:12,fontFamily:"Consolas",fontWeight:600},children:[b.blockSemi," ENVIRONMENT CONNECTION STRINGS"]}),["dev","staging","qa","production"].map(i=>{const x=i==="production",g=n.environment_connections[i],S=A[i],F=k.testing&&k.env===i;return o.jsx("div",{style:{marginBottom:16},children:o.jsx(re,{value:g,onChange:w=>{c($=>({...$,environment_connections:{...$.environment_connections,[i]:w}})),p($=>({...$,[i]:void 0}))},dbEngine:n.db_engine,label:`${i.charAt(0).toUpperCase()+i.slice(1)} Connection`,required:x,onTestConnection:()=>u(i),isTesting:F,testResult:S||null})},i)})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Forward SQL *"}),o.jsx("textarea",{value:n.forward_sql,onChange:i=>c({...n,forward_sql:i.target.value}),placeholder:"ALTER TABLE users ADD COLUMN email VARCHAR(255);",rows:8,style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,resize:"vertical"}})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,fontFamily:"Consolas"},children:"Rollback SQL * (MANDATORY)"}),o.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[o.jsxs("select",{value:R,onChange:i=>D(i.target.value),style:{padding:"6px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,cursor:"pointer"},children:[o.jsx("option",{value:"dev",children:"Test on Dev"}),o.jsx("option",{value:"staging",children:"Test on Staging"}),o.jsx("option",{value:"qa",children:"Test on QA"}),o.jsx("option",{value:"production",children:"Test on Production"})]}),o.jsx("button",{type:"button",onClick:f,disabled:_||!n.forward_sql||!n.rollback_sql||!n.environment_connections[R],style:{padding:"6px 12px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:_||!n.forward_sql||!n.rollback_sql||!n.environment_connections[R]?"not-allowed":"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600,opacity:_||!n.forward_sql||!n.rollback_sql||!n.environment_connections[R]?.5:1},children:_?"TESTING...":"TEST SQL"})]})]}),o.jsx("textarea",{value:n.rollback_sql,onChange:i=>{c({...n,rollback_sql:i.target.value}),C(null)},placeholder:"ALTER TABLE users DROP COLUMN email;",rows:8,style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,resize:"vertical"}}),h&&o.jsxs("div",{style:{marginTop:8,padding:8,background:h.success?e.success+"20":e.danger+"20",border:`1px solid ${h.success?e.success:e.danger}`,borderRadius:2,color:h.success?e.success:e.danger,fontSize:11,fontFamily:"Consolas"},children:[h.success?"âœ“ ":"âœ— ",h.message]})]}),j&&o.jsxs("div",{style:{padding:12,background:e.danger+"20",border:`1px solid ${e.danger}`,borderRadius:2,color:e.danger,fontSize:11,fontFamily:"Consolas"},children:[b.blockFull," ERROR: ",j]}),o.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"flex-end",marginTop:8},children:[o.jsx("button",{type:"button",onClick:a,style:{padding:"8px 16px",border:`1px solid ${e.muted}`,borderRadius:2,background:e.muted,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CANCEL"}),o.jsx("button",{type:"submit",disabled:d,style:{padding:"8px 16px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:d?"not-allowed":"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600,opacity:d?.5:1},children:d?"CREATING...":"CREATE MIGRATION"})]})]})})]})})})},de=({migration:a,onClose:v,onApply:n,onRollback:c,onTest:j})=>{const[l,d]=r.useState([]),[m,k]=r.useState(!1),[y,_]=r.useState("dev"),[E,A]=r.useState(null),[p,h]=r.useState(!1);r.useEffect(()=>{C()},[a.migration_name]),r.useEffect(()=>{R()},[y,l]);const C=async()=>{try{k(!0);const u=await z.getHistory(a.migration_name);d(u.history||[])}catch(u){A(T(u))}finally{k(!1)}},R=()=>{const u=l.some(f=>f.environment===y&&f.status==="APPLIED");h(u)},D=u=>{switch(u){case"APPLIED":return e.success;case"PENDING":return e.warning;case"FAILED":return e.danger;case"ROLLED_BACK":return e.muted;default:return e.foreground}};return o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:o.jsx("div",{style:{width:"90%",maxWidth:1e3,maxHeight:"90vh",overflowY:"auto"},children:o.jsxs(q,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${e.border}`},children:[o.jsxs("div",{children:[o.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:e.accent,margin:0,fontFamily:"Consolas"},children:[b.blockFull," MIGRATION DETAILS"]}),o.jsx("p",{style:{fontSize:11,color:e.muted,margin:"4px 0 0 0",fontFamily:"Consolas"},children:a.migration_name})]}),o.jsx("button",{onClick:v,style:{background:"transparent",border:"none",color:e.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:20},children:[o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:16},children:[o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Version"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas",fontWeight:600},children:a.version})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Status"}),o.jsx("div",{style:{fontSize:12,color:D(a.status),fontFamily:"Consolas",fontWeight:600},children:a.status})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"DB Engine"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas",fontWeight:600},children:a.db_engine||"N/A"})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Created At"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas"},children:new Date(a.created_at).toLocaleString()})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Last Applied"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas"},children:a.last_applied_at?new Date(a.last_applied_at).toLocaleString():"Never"})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Checksum"}),o.jsx("div",{style:{fontSize:10,color:e.foreground,fontFamily:"Consolas",wordBreak:"break-all"},children:a.checksum||"N/A"})]})]}),a.description&&o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[b.blockSemi," DESCRIPTION"]}),o.jsx("div",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:12,color:e.foreground,fontFamily:"Consolas",lineHeight:1.6},children:a.description})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[b.blockSemi," FORWARD SQL"]}),o.jsx("pre",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:11,color:e.foreground,fontFamily:"Consolas",overflowX:"auto",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:a.forward_sql||"N/A"})]}),a.rollback_sql&&o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[b.blockSemi," ROLLBACK SQL"]}),o.jsx("pre",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:11,color:e.foreground,fontFamily:"Consolas",overflowX:"auto",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:a.rollback_sql})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,fontFamily:"Consolas",fontWeight:600},children:[b.blockSemi," ACTIONS"]}),o.jsxs("select",{value:y,onChange:u=>_(u.target.value),style:{padding:"6px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,cursor:"pointer"},children:[o.jsx("option",{value:"dev",children:"Development"}),o.jsx("option",{value:"staging",children:"Staging"}),o.jsx("option",{value:"qa",children:"QA"}),o.jsx("option",{value:"production",children:"Production"})]})]}),o.jsxs("div",{style:{display:"flex",gap:12},children:[j&&o.jsx("button",{onClick:()=>j(a),style:{padding:"8px 16px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"ðŸ§ª TEST MIGRATION"}),!p&&o.jsxs("button",{onClick:()=>n(a.migration_name,y),style:{padding:"8px 16px",border:`1px solid ${e.success}`,borderRadius:2,background:e.success,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:["âœ“ APPLY TO ",y.toUpperCase()]}),p&&a.rollback_sql&&o.jsxs("button",{onClick:()=>c(a.migration_name,y),style:{padding:"8px 16px",border:`1px solid ${e.warning}`,borderRadius:2,background:e.warning,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:["â†© ROLLBACK FROM ",y.toUpperCase()]})]})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[b.blockSemi," EXECUTION HISTORY"]}),m?o.jsx("div",{style:{padding:20,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:"Loading history..."}):l.length===0?o.jsx("div",{style:{padding:20,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:"No execution history available"}):o.jsx("div",{style:{border:`1px solid ${e.border}`,borderRadius:2,overflow:"hidden"},children:l.map((u,f)=>o.jsxs("div",{style:{padding:"12px 16px",borderBottom:f<l.length-1?`1px solid ${e.border}`:"none",background:f%2===0?e.background:e.backgroundSoft},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:[o.jsxs("div",{style:{fontSize:12,fontWeight:600,color:e.foreground,fontFamily:"Consolas"},children:[u.environment||"N/A"," - ",u.status||"N/A"]}),o.jsx("div",{style:{fontSize:10,color:e.muted,fontFamily:"Consolas"},children:u.executed_at?new Date(u.executed_at).toLocaleString():"N/A"})]}),u.error_message&&o.jsx("div",{style:{fontSize:10,color:e.danger,fontFamily:"Consolas",marginTop:4,padding:8,background:e.danger+"20",borderRadius:2},children:u.error_message}),u.execution_time_ms&&o.jsxs("div",{style:{fontSize:10,color:e.muted,fontFamily:"Consolas",marginTop:4},children:["Execution time: ",u.execution_time_ms,"ms"]})]},f))})]}),E&&o.jsxs("div",{style:{padding:12,background:e.danger+"20",border:`1px solid ${e.danger}`,borderRadius:2,color:e.danger,fontSize:11,fontFamily:"Consolas"},children:[b.blockFull," ERROR: ",E]}),o.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:8},children:o.jsx("button",{onClick:v,style:{padding:"8px 16px",border:`1px solid ${e.border}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLOSE"})})]})]})})})},ce=({migration:a,onClose:v,onTestSuccess:n})=>{const[c,j]=r.useState(!1),[l,d]=r.useState(null),[m,k]=r.useState(null),[y,_]=r.useState(""),E=async()=>{var p;try{j(!0),k(null),d(null);const h=await z.testMigration(a.migration_name,{environment:"test",test_schema_prefix:"_migration_test_"});d(h),_(h.test_schema||""),h.success?(n&&n(),alert("âœ… Migration test passed! You can now apply it to production.")):alert(`âŒ Migration test failed: ${((p=h.errors)==null?void 0:p.join(", "))||"Unknown error"}`)}catch(h){k(T(h))}finally{j(!1)}},A=async()=>{if(y)try{await z.cleanupTestSchema(y),_(""),d(null),alert("âœ… Test schema cleaned up successfully")}catch(p){k(T(p))}};return o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:o.jsx("div",{style:{width:"90%",maxWidth:700,maxHeight:"90vh",overflowY:"auto"},children:o.jsxs(q,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${e.border}`},children:[o.jsxs("div",{children:[o.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:e.accent,margin:0,fontFamily:"Consolas"},children:[b.blockFull," TEST MIGRATION"]}),o.jsx("p",{style:{fontSize:11,color:e.muted,margin:"4px 0 0 0",fontFamily:"Consolas"},children:a.migration_name})]}),o.jsx("button",{onClick:v,style:{background:"transparent",border:"none",color:e.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16},children:[o.jsxs("div",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:11,fontFamily:"Consolas",lineHeight:1.6},children:[o.jsxs("div",{style:{fontWeight:600,marginBottom:8,color:e.foreground},children:[b.blockSemi," How it works:"]}),o.jsxs("ul",{style:{margin:0,paddingLeft:20,color:e.muted},children:[o.jsx("li",{children:"Creates a temporary test schema"}),o.jsx("li",{children:"Executes the forward SQL in the test schema"}),o.jsx("li",{children:"Validates that the migration works correctly"}),o.jsx("li",{children:"Tests the rollback SQL"}),o.jsx("li",{children:"Cleans up the test schema automatically"})]})]}),m&&o.jsxs("div",{style:{padding:12,background:e.danger+"20",border:`1px solid ${e.danger}`,borderRadius:2,color:e.danger,fontSize:11,fontFamily:"Consolas"},children:[b.blockFull," ERROR: ",m]}),l&&o.jsxs("div",{style:{padding:12,background:l.success?e.success+"20":e.danger+"20",border:`1px solid ${l.success?e.success:e.danger}`,borderRadius:2,fontSize:11,fontFamily:"Consolas"},children:[o.jsx("div",{style:{fontWeight:600,marginBottom:8,color:l.success?e.success:e.danger},children:l.success?"âœ“ TEST PASSED":"âœ— TEST FAILED"}),l.test_schema&&o.jsxs("div",{style:{color:e.muted,marginBottom:4},children:["Test Schema: ",l.test_schema]}),l.execution_time_ms&&o.jsxs("div",{style:{color:e.muted,marginBottom:4},children:["Execution Time: ",l.execution_time_ms,"ms"]}),l.errors&&l.errors.length>0&&o.jsxs("div",{style:{marginTop:8},children:[o.jsx("div",{style:{fontWeight:600,marginBottom:4,color:e.danger},children:"Errors:"}),l.errors.map((p,h)=>o.jsxs("div",{style:{color:e.danger,marginLeft:12},children:["â€¢ ",p]},h))]})]}),o.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"flex-end"},children:[y&&o.jsx("button",{onClick:A,style:{padding:"8px 16px",border:`1px solid ${e.warning}`,borderRadius:2,background:e.warning,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLEANUP TEST SCHEMA"}),o.jsx("button",{onClick:E,disabled:c,style:{padding:"8px 16px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:c?"not-allowed":"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600,opacity:c?.5:1},children:c?"TESTING...":"RUN TEST"}),o.jsx("button",{onClick:v,style:{padding:"8px 16px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLOSE"})]})]})]})})})},ue=10,Ce=()=>{const{page:a,limit:v,offset:n,setPage:c,calculateTotalPages:j}=ne(1,ue),{filters:l,setFilter:d}=te({status:"",environment:"",db_engine:""}),[m,k]=r.useState(""),[y,_]=r.useState(""),[E,A]=r.useState(null),[p,h]=r.useState([]),[C,R]=r.useState(!0),[D,u]=r.useState(!1),[f,B]=r.useState(null),[i,x]=r.useState(!1),[g,S]=r.useState(!1);r.useState("migrations");const F=r.useRef(!0);r.useEffect(()=>(F.current=!0,()=>{F.current=!1}),[]);const w=r.useCallback(async()=>{if(!F.current)return;const t=Date.now(),M=300;try{R(!0),A(null);const I={page:1,limit:1e4,search:se(y,100)};l.status&&(I.status=l.status),l.environment&&(I.environment=l.environment),l.db_engine&&(I.db_engine=l.db_engine);const V=(await z.getAll(I)).migrations||[],U=Date.now()-t,K=Math.max(0,M-U);await new Promise(X=>setTimeout(X,K)),F.current&&h(V)}catch(L){console.error("Error in fetchAllMigrations:",L),F.current&&A(T(L))}finally{F.current&&R(!1)}},[y,l]);r.useEffect(()=>{w()},[w]);const $=r.useMemo(()=>j(p.length),[p.length,j]);r.useMemo(()=>p.slice(n,n+v),[p,n,v]),r.useEffect(()=>{$>=1&&a>$&&c(1)},[$,a,c]);const O=r.useCallback(()=>{_(m),c(1)},[m,c]),H=r.useCallback(()=>{u(!0)},[]),G=r.useCallback(()=>{u(!1),w()},[w]),Y=r.useCallback(t=>{B(t),x(!0)},[]),W=r.useCallback(t=>{B(t),S(!0)},[]),N=r.useCallback(async(t,M)=>{try{await z.apply(t,M),alert("âœ… Migration applied successfully"),w(),(f==null?void 0:f.migration_name)===t&&x(!1)}catch(L){F.current&&A(T(L))}},[w,f]),P=r.useCallback(async(t,M)=>{const L=`âš ï¸ WARNING: This will rollback migration "${t}" in environment "${M}".

This action cannot be undone. Are you absolutely sure?`;if(confirm(L))try{await z.rollback(t,M),alert("âœ… Migration rolled back successfully"),w(),(f==null?void 0:f.migration_name)===t&&x(!1)}catch(I){F.current&&A(T(I))}},[w,f]);return C&&p.length===0?o.jsx(oe,{variant:"table"}):o.jsxs(J,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:s.spacing.lg,paddingBottom:s.spacing.md,borderBottom:`2px solid ${e.accent}`},children:[o.jsxs("h1",{style:{fontSize:14,fontWeight:600,margin:0,color:e.foreground,textTransform:"uppercase",fontFamily:"Consolas"},children:[o.jsx("span",{style:{color:e.accent,marginRight:s.spacing.sm},children:b.blockFull}),"SCHEMA MIGRATIONS"]}),o.jsx(ee,{label:`${b.blockSemi} CREATE MIGRATION`,onClick:H})]}),o.jsxs("div",{style:{display:"flex",gap:s.spacing.sm,marginBottom:s.spacing.md,flexWrap:"wrap",alignItems:"center"},children:[o.jsx("input",{type:"text",value:m,onChange:t=>k(t.target.value),onKeyPress:t=>t.key==="Enter"&&O(),placeholder:"Search migrations...",style:{flex:1,minWidth:200,padding:`${s.spacing.sm} ${s.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"}}),o.jsx("button",{onClick:O,style:{minWidth:100,padding:`${s.spacing.sm} ${s.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"SEARCH"}),o.jsxs("select",{value:l.status,onChange:t=>{d("status",t.target.value),c(1)},style:{padding:`${s.spacing.sm} ${s.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer",outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"},children:[o.jsx("option",{value:"",children:"All Status"}),o.jsx("option",{value:"PENDING",children:"Pending"}),o.jsx("option",{value:"APPLIED",children:"Applied"}),o.jsx("option",{value:"FAILED",children:"Failed"}),o.jsx("option",{value:"ROLLED_BACK",children:"Rolled Back"})]}),o.jsxs("select",{value:l.environment,onChange:t=>{d("environment",t.target.value),c(1)},style:{padding:`${s.spacing.sm} ${s.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer",outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"},children:[o.jsx("option",{value:"",children:"All Environments"}),o.jsx("option",{value:"dev",children:"Development"}),o.jsx("option",{value:"staging",children:"Staging"}),o.jsx("option",{value:"qa",children:"QA"}),o.jsx("option",{value:"production",children:"Production"})]}),o.jsxs("select",{value:l.db_engine,onChange:t=>{d("db_engine",t.target.value),c(1)},style:{padding:`${s.spacing.sm} ${s.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer",outline:"none",transition:"border-color 0.15s ease"},onFocus:t=>{t.target.style.borderColor=e.accent,t.target.style.outline=`2px solid ${e.accent}`,t.target.style.outlineOffset="2px"},onBlur:t=>{t.target.style.borderColor=e.border,t.target.style.outline="none"},children:[o.jsx("option",{value:"",children:"All DB Engines"}),o.jsx("option",{value:"PostgreSQL",children:"PostgreSQL"}),o.jsx("option",{value:"MariaDB",children:"MariaDB"}),o.jsx("option",{value:"MSSQL",children:"MSSQL"}),o.jsx("option",{value:"Oracle",children:"Oracle"}),o.jsx("option",{value:"MongoDB",children:"MongoDB"})]})]}),E&&o.jsxs("div",{style:{padding:s.spacing.sm,marginBottom:s.spacing.md,background:e.backgroundSoft,border:`1px solid ${e.border}`,borderRadius:2,color:e.foreground,fontSize:12,fontFamily:"Consolas"},children:[b.blockFull," ERROR: ",E]}),o.jsx(le,{migrations:p,loading:C,onViewMigration:Y,onApplyMigration:N,onRollbackMigration:P,onTestMigration:W}),D&&o.jsx(ae,{onClose:()=>u(!1),onSuccess:G}),i&&f&&o.jsx(de,{migration:f,onClose:()=>{x(!1),B(null)},onApply:N,onRollback:P,onTest:W}),g&&f&&o.jsx(ce,{migration:f,onClose:()=>{S(!1),B(null)},onTestSuccess:()=>{S(!1),w()}})]})};export{Ce as default};
