import{r,j as e,b as o,e as h,a0 as G,a1 as T}from"./index-75d7470b.js";import{A as I}from"./AsciiPanel-9f053981.js";import{A as V}from"./AsciiButton-446d8430.js";import{S as Y}from"./SkeletonLoader-530eacc4.js";import{u as U}from"./usePagination-b946ac42.js";import{u as K}from"./useTableFilters-0b8dd77f.js";import{e as F}from"./errorHandler-5ea9ae85.js";import{s as X}from"./validation-24839588.js";import{C as J}from"./ConnectionStringSelector-c1083be0.js";const Z=({migrations:i,loading:b,onViewMigration:n,onApplyMigration:x,onRollbackMigration:k,onTestMigration:l})=>{const[j,_]=r.useState(new Set),S=p=>{_(d=>{const t=new Set(d);return t.has(p)?t.delete(p):t.add(p),t})},y=r.useMemo(()=>{const p={};return i.forEach(d=>{const t=d.version||"unversioned";p[t]||(p[t]=[]),p[t].push(d)}),p},[i]),v=p=>{switch(p){case"APPLIED":return o.success;case"PENDING":return o.warning;case"FAILED":return o.danger;case"ROLLED_BACK":return o.muted;default:return o.foreground}},w=p=>{switch(p){case"APPLIED":return"âœ“";case"PENDING":return"â³";case"FAILED":return"âœ—";case"ROLLED_BACK":return"â†©";default:return"?"}};return b?e.jsxs("div",{style:{padding:40,textAlign:"center",color:o.muted,fontFamily:"Consolas"},children:[h.blockSemi," Loading migrations..."]}):i.length===0?e.jsxs("div",{style:{padding:40,textAlign:"center",color:o.muted,fontFamily:"Consolas"},children:[h.blockSemi," No migrations found. Create your first migration to get started."]}):e.jsx("div",{style:{border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,maxHeight:"70vh",overflowY:"auto"},children:Object.entries(y).map(([p,d])=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsxs("div",{style:{padding:"8px 12px",background:o.background,borderBottom:`1px solid ${o.border}`,fontSize:11,fontWeight:600,color:o.accent,fontFamily:"Consolas"},children:[h.blockSemi," VERSION: ",p," (",d.length," migrations)"]}),d.map(t=>{const a=j.has(t.migration_name);return e.jsxs("div",{style:{borderBottom:`1px solid ${o.border}`},children:[e.jsxs("div",{onClick:()=>S(t.migration_name),style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:12,background:a?o.backgroundSoft:"transparent",transition:"background 0.2s"},onMouseEnter:c=>{a||(c.currentTarget.style.background=o.backgroundSoft)},onMouseLeave:c=>{a||(c.currentTarget.style.background="transparent")},children:[e.jsx("span",{style:{fontSize:14,color:o.foreground,fontFamily:"Consolas",minWidth:20},children:a?h.tDown:h.tRight}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontSize:13,fontWeight:600,color:o.foreground,fontFamily:"Consolas",marginBottom:4},children:t.migration_name}),e.jsxs("div",{style:{fontSize:11,color:o.muted,fontFamily:"Consolas",display:"flex",gap:16,flexWrap:"wrap"},children:[e.jsxs("span",{children:["Version: ",t.version]}),e.jsxs("span",{children:["DB: ",t.db_engine||"N/A"]}),e.jsxs("span",{children:["Created: ",new Date(t.created_at).toLocaleDateString()]})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsxs("span",{style:{padding:"4px 8px",borderRadius:2,fontSize:10,fontWeight:600,background:v(t.status)+"40",color:v(t.status),fontFamily:"Consolas",border:`1px solid ${v(t.status)}`},children:[w(t.status)," ",t.status]}),e.jsx("button",{onClick:c=>{c.stopPropagation(),n(t)},style:{padding:"4px 8px",border:`1px solid ${o.border}`,borderRadius:2,background:o.accent,color:o.background,cursor:"pointer",fontSize:10,fontFamily:"Consolas",fontWeight:600},children:"VIEW"})]})]}),a&&e.jsxs("div",{style:{padding:"16px 16px 16px 48px",background:o.background,borderTop:`1px solid ${o.border}`},children:[e.jsx("div",{style:{fontSize:11,color:o.muted,fontFamily:"Consolas",marginBottom:12,lineHeight:1.6},children:t.description||"No description provided."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:12,marginBottom:12},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4},children:"Checksum"}),e.jsx("div",{style:{fontSize:11,color:o.foreground,fontFamily:"Consolas",wordBreak:"break-all"},children:t.checksum||"N/A"})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4},children:"Created At"}),e.jsx("div",{style:{fontSize:11,color:o.foreground,fontFamily:"Consolas"},children:new Date(t.created_at).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4},children:"Last Applied"}),e.jsx("div",{style:{fontSize:11,color:o.foreground,fontFamily:"Consolas"},children:t.last_applied_at?new Date(t.last_applied_at).toLocaleString():"Never"})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:12,flexWrap:"wrap"},children:[l&&e.jsx("button",{onClick:c=>{c.stopPropagation(),l(t)},style:{padding:"6px 12px",border:`1px solid ${o.accent}`,borderRadius:2,background:o.accent,color:o.background,cursor:"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600},children:"ðŸ§ª TEST"}),t.status!=="APPLIED"&&e.jsx("button",{onClick:c=>{c.stopPropagation();const R=prompt("Enter environment (dev/staging/qa/production):");R&&x(t.migration_name,R)},style:{padding:"6px 12px",border:`1px solid ${o.success}`,borderRadius:2,background:o.success,color:o.background,cursor:"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600},children:"âœ“ APPLY"}),t.status==="APPLIED"&&e.jsx("button",{onClick:c=>{c.stopPropagation();const R=prompt("Enter environment (dev/staging/qa/production):");R&&k(t.migration_name,R)},style:{padding:"6px 12px",border:`1px solid ${o.warning}`,borderRadius:2,background:o.warning,color:o.background,cursor:"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600},children:"â†© ROLLBACK"})]})]})]},t.migration_name)})]},p))})},N=i=>{switch(i){case"PostgreSQL":return"postgresql://username:password@localhost:5432/database_name";case"MariaDB":return"mysql://username:password@localhost:3306/database_name";case"MSSQL":return"mssql://username:password@localhost:1433/database_name";case"MongoDB":return"mongodb://username:password@localhost:27017/database_name?authSource=admin";case"Oracle":return"oracle://username:password@localhost:1521/XE";default:return"postgresql://username:password@localhost:5432/database_name"}},ee=({onClose:i,onSuccess:b})=>{const[n,x]=r.useState({migration_name:"",version:"",description:"",db_engine:"PostgreSQL",forward_sql:"",rollback_sql:"",environment_connections:{dev:"",staging:"",qa:"",production:N("PostgreSQL")}}),[k,l]=r.useState(null),[j,_]=r.useState(!1),[S,y]=r.useState({env:"",testing:!1}),[v,w]=r.useState(!1),[p,d]=r.useState({}),[t,a]=r.useState(null),[c,R]=r.useState("production");r.useEffect(()=>{const s=N(n.db_engine),g=["postgresql://username:password@localhost:5432/database_name","mysql://username:password@localhost:3306/database_name","mssql://username:password@localhost:1433/database_name","mongodb://username:password@localhost:27017/database_name?authSource=admin","oracle://username:password@localhost:1521/XE"];x(f=>{const C={...f.environment_connections};return(!C.production||g.includes(C.production))&&(C.production=s),{...f,environment_connections:C}})},[n.db_engine]);const u=async s=>{const g=n.environment_connections[s];if(!g||g.trim()===""){d(f=>({...f,[s]:{success:!1,message:"Connection string is required"}}));return}y({env:s,testing:!0}),d(f=>({...f,[s]:null})),l(null);try{await G.testConnection(n.db_engine,g),d(f=>({...f,[s]:{success:!0,message:"Connection successful!"}}))}catch(f){d(C=>({...C,[s]:{success:!1,message:F(f)}}))}finally{y({env:"",testing:!1})}},E=async()=>{var g;if(!n.forward_sql||n.forward_sql.trim()===""){a({success:!1,message:"Forward SQL is required"});return}if(!n.rollback_sql||n.rollback_sql.trim()===""){a({success:!1,message:"Rollback SQL is required"});return}const s=n.environment_connections[c];if(!s||s.trim()===""){a({success:!1,message:`Connection string for ${c} is required`});return}w(!0),a(null),l(null);try{const f=await T.testSQL({db_engine:n.db_engine,connection_string:s,forward_sql:n.forward_sql,rollback_sql:n.rollback_sql});a({success:f.success,message:f.message||(f.success?"SQL test successful! Forward and rollback executed correctly.":((g=f.errors)==null?void 0:g.join("; "))||"SQL test failed")})}catch(f){a({success:!1,message:F(f)})}finally{w(!1)}},M=async s=>{if(s.preventDefault(),l(null),!n.migration_name||!n.version||!n.forward_sql){l("Migration name, version, and forward SQL are required");return}if(!n.rollback_sql||n.rollback_sql.trim()===""){l("Rollback SQL is MANDATORY. Every migration must have a rollback strategy.");return}if(!n.environment_connections.production||n.environment_connections.production.trim()===""){l("Production Connection String is MANDATORY.");return}_(!0);try{const g={};Object.entries(n.environment_connections).forEach(([f,C])=>{C&&C.trim()!==""&&(g[f]=C.trim())}),await T.create({...n,environment_connections:g}),b()}catch(g){l(F(g))}finally{_(!1)}};return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsx("div",{style:{width:"90%",maxWidth:800,maxHeight:"90vh",overflowY:"auto"},children:e.jsxs(I,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${o.border}`},children:[e.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:o.accent,margin:0,fontFamily:"Consolas"},children:[h.blockFull," CREATE MIGRATION"]}),e.jsx("button",{onClick:i,style:{background:"transparent",border:"none",color:o.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),e.jsx("form",{onSubmit:M,children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:11,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Migration Name *"}),e.jsx("input",{type:"text",value:n.migration_name,onChange:s=>x({...n,migration_name:s.target.value}),placeholder:"e.g., add_user_email_column",style:{width:"100%",padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12}})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:11,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Version *"}),e.jsx("input",{type:"text",value:n.version,onChange:s=>x({...n,version:s.target.value}),placeholder:"e.g., 1.0.0",style:{width:"100%",padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:11,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"DB Engine"}),e.jsxs("select",{value:n.db_engine,onChange:s=>x({...n,db_engine:s.target.value}),style:{width:"100%",padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer"},children:[e.jsx("option",{value:"PostgreSQL",children:"PostgreSQL"}),e.jsx("option",{value:"MariaDB",children:"MariaDB"}),e.jsx("option",{value:"MSSQL",children:"MSSQL"}),e.jsx("option",{value:"Oracle",children:"Oracle"}),e.jsx("option",{value:"MongoDB",children:"MongoDB"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:11,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Description"}),e.jsx("textarea",{value:n.description,onChange:s=>x({...n,description:s.target.value}),placeholder:"Describe what this migration does...",rows:3,style:{width:"100%",padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12,resize:"vertical"}})]}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:11,color:o.muted,marginBottom:12,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," ENVIRONMENT CONNECTION STRINGS"]}),["dev","staging","qa","production"].map(s=>{const g=s==="production",f=n.environment_connections[s],C=p[s],D=S.testing&&S.env===s;return e.jsx("div",{style:{marginBottom:16},children:e.jsx(J,{value:f,onChange:$=>{x(A=>({...A,environment_connections:{...A.environment_connections,[s]:$}})),d(A=>({...A,[s]:void 0}))},dbEngine:n.db_engine,label:`${s.charAt(0).toUpperCase()+s.slice(1)} Connection`,required:g,onTestConnection:()=>u(s),isTesting:D,testResult:C||null})},s)})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontSize:11,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Forward SQL *"}),e.jsx("textarea",{value:n.forward_sql,onChange:s=>x({...n,forward_sql:s.target.value}),placeholder:"ALTER TABLE users ADD COLUMN email VARCHAR(255);",rows:8,style:{width:"100%",padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:11,resize:"vertical"}})]}),e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:[e.jsx("label",{style:{display:"block",fontSize:11,color:o.muted,fontFamily:"Consolas"},children:"Rollback SQL * (MANDATORY)"}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsxs("select",{value:c,onChange:s=>R(s.target.value),style:{padding:"6px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:11,cursor:"pointer"},children:[e.jsx("option",{value:"dev",children:"Test on Dev"}),e.jsx("option",{value:"staging",children:"Test on Staging"}),e.jsx("option",{value:"qa",children:"Test on QA"}),e.jsx("option",{value:"production",children:"Test on Production"})]}),e.jsx("button",{type:"button",onClick:E,disabled:v||!n.forward_sql||!n.rollback_sql||!n.environment_connections[c],style:{padding:"6px 12px",border:`1px solid ${o.accent}`,borderRadius:2,background:o.accent,color:o.background,cursor:v||!n.forward_sql||!n.rollback_sql||!n.environment_connections[c]?"not-allowed":"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600,opacity:v||!n.forward_sql||!n.rollback_sql||!n.environment_connections[c]?.5:1},children:v?"TESTING...":"TEST SQL"})]})]}),e.jsx("textarea",{value:n.rollback_sql,onChange:s=>{x({...n,rollback_sql:s.target.value}),a(null)},placeholder:"ALTER TABLE users DROP COLUMN email;",rows:8,style:{width:"100%",padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:11,resize:"vertical"}}),t&&e.jsxs("div",{style:{marginTop:8,padding:8,background:t.success?o.success+"20":o.danger+"20",border:`1px solid ${t.success?o.success:o.danger}`,borderRadius:2,color:t.success?o.success:o.danger,fontSize:11,fontFamily:"Consolas"},children:[t.success?"âœ“ ":"âœ— ",t.message]})]}),k&&e.jsxs("div",{style:{padding:12,background:o.danger+"20",border:`1px solid ${o.danger}`,borderRadius:2,color:o.danger,fontSize:11,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",k]}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",onClick:i,style:{padding:"8px 16px",border:`1px solid ${o.muted}`,borderRadius:2,background:o.muted,color:o.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CANCEL"}),e.jsx("button",{type:"submit",disabled:j,style:{padding:"8px 16px",border:`1px solid ${o.accent}`,borderRadius:2,background:o.accent,color:o.background,cursor:j?"not-allowed":"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600,opacity:j?.5:1},children:j?"CREATING...":"CREATE MIGRATION"})]})]})})]})})})},oe=({migration:i,onClose:b,onApply:n,onRollback:x,onTest:k})=>{const[l,j]=r.useState([]),[_,S]=r.useState(!1),[y,v]=r.useState("dev"),[w,p]=r.useState(null),[d,t]=r.useState(!1);r.useEffect(()=>{a()},[i.migration_name]),r.useEffect(()=>{c()},[y,l]);const a=async()=>{try{S(!0);const u=await T.getHistory(i.migration_name);j(u.history||[])}catch(u){p(F(u))}finally{S(!1)}},c=()=>{const u=l.some(E=>E.environment===y&&E.status==="APPLIED");t(u)},R=u=>{switch(u){case"APPLIED":return o.success;case"PENDING":return o.warning;case"FAILED":return o.danger;case"ROLLED_BACK":return o.muted;default:return o.foreground}};return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsx("div",{style:{width:"90%",maxWidth:1e3,maxHeight:"90vh",overflowY:"auto"},children:e.jsxs(I,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${o.border}`},children:[e.jsxs("div",{children:[e.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:o.accent,margin:0,fontFamily:"Consolas"},children:[h.blockFull," MIGRATION DETAILS"]}),e.jsx("p",{style:{fontSize:11,color:o.muted,margin:"4px 0 0 0",fontFamily:"Consolas"},children:i.migration_name})]}),e.jsx("button",{onClick:b,style:{background:"transparent",border:"none",color:o.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:20},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:16},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Version"}),e.jsx("div",{style:{fontSize:12,color:o.foreground,fontFamily:"Consolas",fontWeight:600},children:i.version})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Status"}),e.jsx("div",{style:{fontSize:12,color:R(i.status),fontFamily:"Consolas",fontWeight:600},children:i.status})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"DB Engine"}),e.jsx("div",{style:{fontSize:12,color:o.foreground,fontFamily:"Consolas",fontWeight:600},children:i.db_engine||"N/A"})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Created At"}),e.jsx("div",{style:{fontSize:12,color:o.foreground,fontFamily:"Consolas"},children:new Date(i.created_at).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Last Applied"}),e.jsx("div",{style:{fontSize:12,color:o.foreground,fontFamily:"Consolas"},children:i.last_applied_at?new Date(i.last_applied_at).toLocaleString():"Never"})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:10,color:o.muted,marginBottom:4,fontFamily:"Consolas"},children:"Checksum"}),e.jsx("div",{style:{fontSize:10,color:o.foreground,fontFamily:"Consolas",wordBreak:"break-all"},children:i.checksum||"N/A"})]})]}),i.description&&e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:11,color:o.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," DESCRIPTION"]}),e.jsx("div",{style:{padding:12,background:o.backgroundSoft,borderRadius:2,border:`1px solid ${o.border}`,fontSize:12,color:o.foreground,fontFamily:"Consolas",lineHeight:1.6},children:i.description})]}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:11,color:o.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," FORWARD SQL"]}),e.jsx("pre",{style:{padding:12,background:o.backgroundSoft,borderRadius:2,border:`1px solid ${o.border}`,fontSize:11,color:o.foreground,fontFamily:"Consolas",overflowX:"auto",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:i.forward_sql||"N/A"})]}),i.rollback_sql&&e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:11,color:o.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," ROLLBACK SQL"]}),e.jsx("pre",{style:{padding:12,background:o.backgroundSoft,borderRadius:2,border:`1px solid ${o.border}`,fontSize:11,color:o.foreground,fontFamily:"Consolas",overflowX:"auto",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:i.rollback_sql})]}),e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[e.jsxs("div",{style:{fontSize:11,color:o.muted,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," ACTIONS"]}),e.jsxs("select",{value:y,onChange:u=>v(u.target.value),style:{padding:"6px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:11,cursor:"pointer"},children:[e.jsx("option",{value:"dev",children:"Development"}),e.jsx("option",{value:"staging",children:"Staging"}),e.jsx("option",{value:"qa",children:"QA"}),e.jsx("option",{value:"production",children:"Production"})]})]}),e.jsxs("div",{style:{display:"flex",gap:12},children:[k&&e.jsx("button",{onClick:()=>k(i),style:{padding:"8px 16px",border:`1px solid ${o.accent}`,borderRadius:2,background:o.accent,color:o.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"ðŸ§ª TEST MIGRATION"}),!d&&e.jsxs("button",{onClick:()=>n(i.migration_name,y),style:{padding:"8px 16px",border:`1px solid ${o.success}`,borderRadius:2,background:o.success,color:o.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:["âœ“ APPLY TO ",y.toUpperCase()]}),d&&i.rollback_sql&&e.jsxs("button",{onClick:()=>x(i.migration_name,y),style:{padding:"8px 16px",border:`1px solid ${o.warning}`,borderRadius:2,background:o.warning,color:o.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:["â†© ROLLBACK FROM ",y.toUpperCase()]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:11,color:o.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," EXECUTION HISTORY"]}),_?e.jsx("div",{style:{padding:20,textAlign:"center",color:o.muted,fontFamily:"Consolas"},children:"Loading history..."}):l.length===0?e.jsx("div",{style:{padding:20,textAlign:"center",color:o.muted,fontFamily:"Consolas"},children:"No execution history available"}):e.jsx("div",{style:{border:`1px solid ${o.border}`,borderRadius:2,overflow:"hidden"},children:l.map((u,E)=>e.jsxs("div",{style:{padding:"12px 16px",borderBottom:E<l.length-1?`1px solid ${o.border}`:"none",background:E%2===0?o.background:o.backgroundSoft},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:[e.jsxs("div",{style:{fontSize:12,fontWeight:600,color:o.foreground,fontFamily:"Consolas"},children:[u.environment||"N/A"," - ",u.status||"N/A"]}),e.jsx("div",{style:{fontSize:10,color:o.muted,fontFamily:"Consolas"},children:u.executed_at?new Date(u.executed_at).toLocaleString():"N/A"})]}),u.error_message&&e.jsx("div",{style:{fontSize:10,color:o.danger,fontFamily:"Consolas",marginTop:4,padding:8,background:o.danger+"20",borderRadius:2},children:u.error_message}),u.execution_time_ms&&e.jsxs("div",{style:{fontSize:10,color:o.muted,fontFamily:"Consolas",marginTop:4},children:["Execution time: ",u.execution_time_ms,"ms"]})]},E))})]}),w&&e.jsxs("div",{style:{padding:12,background:o.danger+"20",border:`1px solid ${o.danger}`,borderRadius:2,color:o.danger,fontSize:11,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",w]}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:8},children:e.jsx("button",{onClick:b,style:{padding:"8px 16px",border:`1px solid ${o.border}`,borderRadius:2,background:o.accent,color:o.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLOSE"})})]})]})})})},ne=({migration:i,onClose:b,onTestSuccess:n})=>{const[x,k]=r.useState(!1),[l,j]=r.useState(null),[_,S]=r.useState(null),[y,v]=r.useState(""),w=async()=>{var d;try{k(!0),S(null),j(null);const t=await T.testMigration(i.migration_name,{environment:"test",test_schema_prefix:"_migration_test_"});j(t),v(t.test_schema||""),t.success?(n&&n(),alert("âœ… Migration test passed! You can now apply it to production.")):alert(`âŒ Migration test failed: ${((d=t.errors)==null?void 0:d.join(", "))||"Unknown error"}`)}catch(t){S(F(t))}finally{k(!1)}},p=async()=>{if(y)try{await T.cleanupTestSchema(y),v(""),j(null),alert("âœ… Test schema cleaned up successfully")}catch(d){S(F(d))}};return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsx("div",{style:{width:"90%",maxWidth:700,maxHeight:"90vh",overflowY:"auto"},children:e.jsxs(I,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${o.border}`},children:[e.jsxs("div",{children:[e.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:o.accent,margin:0,fontFamily:"Consolas"},children:[h.blockFull," TEST MIGRATION"]}),e.jsx("p",{style:{fontSize:11,color:o.muted,margin:"4px 0 0 0",fontFamily:"Consolas"},children:i.migration_name})]}),e.jsx("button",{onClick:b,style:{background:"transparent",border:"none",color:o.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16},children:[e.jsxs("div",{style:{padding:12,background:o.backgroundSoft,borderRadius:2,border:`1px solid ${o.border}`,fontSize:11,fontFamily:"Consolas",lineHeight:1.6},children:[e.jsxs("div",{style:{fontWeight:600,marginBottom:8,color:o.foreground},children:[h.blockSemi," How it works:"]}),e.jsxs("ul",{style:{margin:0,paddingLeft:20,color:o.muted},children:[e.jsx("li",{children:"Creates a temporary test schema"}),e.jsx("li",{children:"Executes the forward SQL in the test schema"}),e.jsx("li",{children:"Validates that the migration works correctly"}),e.jsx("li",{children:"Tests the rollback SQL"}),e.jsx("li",{children:"Cleans up the test schema automatically"})]})]}),_&&e.jsxs("div",{style:{padding:12,background:o.danger+"20",border:`1px solid ${o.danger}`,borderRadius:2,color:o.danger,fontSize:11,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",_]}),l&&e.jsxs("div",{style:{padding:12,background:l.success?o.success+"20":o.danger+"20",border:`1px solid ${l.success?o.success:o.danger}`,borderRadius:2,fontSize:11,fontFamily:"Consolas"},children:[e.jsx("div",{style:{fontWeight:600,marginBottom:8,color:l.success?o.success:o.danger},children:l.success?"âœ“ TEST PASSED":"âœ— TEST FAILED"}),l.test_schema&&e.jsxs("div",{style:{color:o.muted,marginBottom:4},children:["Test Schema: ",l.test_schema]}),l.execution_time_ms&&e.jsxs("div",{style:{color:o.muted,marginBottom:4},children:["Execution Time: ",l.execution_time_ms,"ms"]}),l.errors&&l.errors.length>0&&e.jsxs("div",{style:{marginTop:8},children:[e.jsx("div",{style:{fontWeight:600,marginBottom:4,color:o.danger},children:"Errors:"}),l.errors.map((d,t)=>e.jsxs("div",{style:{color:o.danger,marginLeft:12},children:["â€¢ ",d]},t))]})]}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"flex-end"},children:[y&&e.jsx("button",{onClick:p,style:{padding:"8px 16px",border:`1px solid ${o.warning}`,borderRadius:2,background:o.warning,color:o.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLEANUP TEST SCHEMA"}),e.jsx("button",{onClick:w,disabled:x,style:{padding:"8px 16px",border:`1px solid ${o.accent}`,borderRadius:2,background:o.accent,color:o.background,cursor:x?"not-allowed":"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600,opacity:x?.5:1},children:x?"TESTING...":"RUN TEST"}),e.jsx("button",{onClick:b,style:{padding:"8px 16px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLOSE"})]})]})]})})})},pe=()=>{const{setPage:i}=U(1,20),{filters:b,setFilter:n}=K({status:"",environment:"",db_engine:""}),[x,k]=r.useState(""),[l,j]=r.useState(""),[_,S]=r.useState(null),[y,v]=r.useState([]),[w,p]=r.useState(!0),[d,t]=r.useState(!1),[a,c]=r.useState(null),[R,u]=r.useState(!1),[E,M]=r.useState(!1);r.useState("migrations");const s=r.useRef(!0);r.useEffect(()=>(s.current=!0,()=>{s.current=!1}),[]);const g=r.useCallback(async()=>{if(!s.current)return;const m=Date.now(),L=300;try{p(!0),S(null);const B={page:1,limit:1e4,search:X(l,100)};b.status&&(B.status=b.status),b.environment&&(B.environment=b.environment),b.db_engine&&(B.db_engine=b.db_engine);const P=(await T.getAll(B)).migrations||[],W=Date.now()-m,Q=Math.max(0,L-W);await new Promise(H=>setTimeout(H,Q)),s.current&&v(P)}catch(z){console.error("Error in fetchAllMigrations:",z),s.current&&S(F(z))}finally{s.current&&p(!1)}},[l,b]);r.useEffect(()=>{g()},[g]);const f=r.useCallback(()=>{j(x),i(1)},[x,i]),C=r.useCallback(()=>{t(!0)},[]),D=r.useCallback(()=>{t(!1),g()},[g]),$=r.useCallback(m=>{c(m),u(!0)},[]),A=r.useCallback(m=>{c(m),M(!0)},[]),q=r.useCallback(async(m,L)=>{try{await T.apply(m,L),alert("âœ… Migration applied successfully"),g(),(a==null?void 0:a.migration_name)===m&&u(!1)}catch(z){s.current&&S(F(z))}},[g,a]),O=r.useCallback(async(m,L)=>{const z=`âš ï¸ WARNING: This will rollback migration "${m}" in environment "${L}".

This action cannot be undone. Are you absolutely sure?`;if(confirm(z))try{await T.rollback(m,L),alert("âœ… Migration rolled back successfully"),g(),(a==null?void 0:a.migration_name)===m&&u(!1)}catch(B){s.current&&S(F(B))}},[g,a]);return w&&y.length===0?e.jsx(Y,{variant:"table"}):e.jsxs("div",{style:{padding:"20px",minHeight:"100vh",background:o.background},children:[e.jsxs(I,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${o.border}`},children:[e.jsxs("div",{children:[e.jsxs("h1",{style:{fontSize:24,fontWeight:700,color:o.accent,margin:0,fontFamily:"Consolas"},children:[h.blockFull," SCHEMA MIGRATIONS"]}),e.jsx("p",{style:{fontSize:12,color:o.muted,margin:"4px 0 0 0",fontFamily:"Consolas"},children:"Version control and deployment for database schemas"})]}),e.jsx(V,{label:`${h.blockSemi} CREATE MIGRATION`,onClick:C})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:16,flexWrap:"wrap",alignItems:"center"},children:[e.jsx("input",{type:"text",value:x,onChange:m=>k(m.target.value),onKeyPress:m=>m.key==="Enter"&&f(),placeholder:"Search migrations...",style:{flex:1,minWidth:200,padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12}}),e.jsx("button",{onClick:f,style:{minWidth:100,padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.accent,color:o.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"SEARCH"}),e.jsxs("select",{value:b.status,onChange:m=>{n("status",m.target.value),i(1)},style:{padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer"},children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"PENDING",children:"Pending"}),e.jsx("option",{value:"APPLIED",children:"Applied"}),e.jsx("option",{value:"FAILED",children:"Failed"}),e.jsx("option",{value:"ROLLED_BACK",children:"Rolled Back"})]}),e.jsxs("select",{value:b.environment,onChange:m=>{n("environment",m.target.value),i(1)},style:{padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer"},children:[e.jsx("option",{value:"",children:"All Environments"}),e.jsx("option",{value:"dev",children:"Development"}),e.jsx("option",{value:"staging",children:"Staging"}),e.jsx("option",{value:"qa",children:"QA"}),e.jsx("option",{value:"production",children:"Production"})]}),e.jsxs("select",{value:b.db_engine,onChange:m=>{n("db_engine",m.target.value),i(1)},style:{padding:"8px 12px",border:`1px solid ${o.border}`,borderRadius:2,background:o.backgroundSoft,color:o.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer"},children:[e.jsx("option",{value:"",children:"All DB Engines"}),e.jsx("option",{value:"PostgreSQL",children:"PostgreSQL"}),e.jsx("option",{value:"MariaDB",children:"MariaDB"}),e.jsx("option",{value:"MSSQL",children:"MSSQL"}),e.jsx("option",{value:"Oracle",children:"Oracle"}),e.jsx("option",{value:"MongoDB",children:"MongoDB"})]})]}),_&&e.jsxs("div",{style:{padding:12,marginBottom:16,background:o.danger+"20",border:`1px solid ${o.danger}`,borderRadius:2,color:o.danger,fontSize:12,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",_]}),e.jsx(Z,{migrations:y,loading:w,onViewMigration:$,onApplyMigration:q,onRollbackMigration:O,onTestMigration:A})]}),d&&e.jsx(ee,{onClose:()=>t(!1),onSuccess:D}),R&&a&&e.jsx(oe,{migration:a,onClose:()=>{u(!1),c(null)},onApply:q,onRollback:O,onTest:A}),E&&a&&e.jsx(ne,{migration:a,onClose:()=>{M(!1),c(null)},onTestSuccess:()=>{M(!1),g()}})]})};export{pe as default};
