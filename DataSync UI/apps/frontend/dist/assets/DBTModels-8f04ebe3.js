import{r,j as e,b as t,e as i,Q as f}from"./index-75d7470b.js";import{A}from"./AsciiPanel-9f053981.js";import{A as x}from"./AsciiButton-446d8430.js";import{e as z}from"./errorHandler-5ea9ae85.js";import{s as K}from"./validation-24839588.js";import{S as U}from"./SkeletonLoader-530eacc4.js";const G=({model:n,onClose:b})=>{var T,w;const[o,B]=r.useState({model_name:"",model_type:"sql",materialization:"table",schema_name:"",database_name:"",sql_content:"",config:{},description:"",tags:[],depends_on:[],columns:[],tests:[],documentation:"",metadata:{},version:1,active:!0}),[j,d]=r.useState(null),[m,v]=r.useState(!1),[h,_]=r.useState(null),[C,u]=r.useState(!1);r.useEffect(()=>{n&&B({model_name:n.model_name||"",model_type:n.model_type||"sql",materialization:n.materialization||"table",schema_name:n.schema_name||"",database_name:n.database_name||"",sql_content:n.sql_content||"",config:n.config||{},description:n.description||"",tags:n.tags||[],depends_on:n.depends_on||[],columns:n.columns||[],tests:n.tests||[],documentation:n.documentation||"",metadata:n.metadata||{},version:n.version||1,active:n.active!==void 0?n.active:!0})},[n]);const c=(s,y)=>{B(l=>({...l,[s]:y}))},g=(s,y)=>{const l=y.split(",").map(p=>p.trim()).filter(p=>p);c(s,l)},M=async()=>{if(!o.model_name||!o.sql_content||!o.schema_name){d("Model name, SQL content, and schema name are required");return}try{v(!0),d(null),await f.createOrUpdateModel(o),b()}catch(s){d(z(s))}finally{v(!1)}},S=async()=>{if(!o.model_name){d("Please save the model first before compiling");return}try{u(!0),d(null);const s=await f.compileModel(o.model_name);_(s.compiled_sql)}catch(s){d(z(s))}finally{u(!1)}};return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:"20px"},onClick:s=>{s.target===s.currentTarget&&b()},children:e.jsx(A,{style:{width:"90%",maxWidth:"1200px",maxHeight:"90vh",overflow:"auto"},children:e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[e.jsx("h2",{style:{color:t.cyan,margin:0},children:n?"Edit Model":"New Model"}),e.jsxs(x,{onClick:b,style:{color:t.red},children:[i.close," Close"]})]}),j&&e.jsx("div",{style:{color:t.red,marginBottom:"15px",padding:"10px",border:`1px solid ${t.red}`},children:j}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"15px",marginBottom:"15px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Model Name *"}),e.jsx("input",{type:"text",value:o.model_name,onChange:s=>c("model_name",s.target.value),disabled:!!n,style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Schema Name *"}),e.jsx("input",{type:"text",value:o.schema_name,onChange:s=>c("schema_name",s.target.value),style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Materialization"}),e.jsxs("select",{value:o.materialization,onChange:s=>c("materialization",s.target.value),style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace"},children:[e.jsx("option",{value:"table",children:"Table"}),e.jsx("option",{value:"view",children:"View"}),e.jsx("option",{value:"incremental",children:"Incremental"}),e.jsx("option",{value:"ephemeral",children:"Ephemeral"})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Database Name (optional)"}),e.jsx("input",{type:"text",value:o.database_name||"",onChange:s=>c("database_name",s.target.value),style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace"}})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Description"}),e.jsx("textarea",{value:o.description||"",onChange:s=>c("description",s.target.value),rows:2,style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace",resize:"vertical"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Tags (comma-separated)"}),e.jsx("input",{type:"text",value:((T=o.tags)==null?void 0:T.join(", "))||"",onChange:s=>g("tags",s.target.value),placeholder:"tag1, tag2, tag3",style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Depends On (comma-separated model names)"}),e.jsx("input",{type:"text",value:((w=o.depends_on)==null?void 0:w.join(", "))||"",onChange:s=>g("depends_on",s.target.value),placeholder:"model1, model2",style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace"}})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"SQL Content *"}),e.jsx("textarea",{value:o.sql_content,onChange:s=>c("sql_content",s.target.value),rows:15,style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace",resize:"vertical"},placeholder:"SELECT * FROM {{ ref('other_model') }}"})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("label",{style:{color:t.text,display:"block",marginBottom:"5px"},children:"Documentation (Markdown)"}),e.jsx("textarea",{value:o.documentation||"",onChange:s=>c("documentation",s.target.value),rows:5,style:{width:"100%",padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace",resize:"vertical"}})]}),e.jsx("div",{style:{gridColumn:"1 / -1",display:"flex",gap:"10px",alignItems:"center"},children:e.jsxs("label",{style:{color:t.text,display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx("input",{type:"checkbox",checked:o.active,onChange:s=>c("active",s.target.checked)}),"Active"]})})]}),h&&e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsx("label",{style:{color:t.cyan,display:"block",marginBottom:"5px"},children:"Compiled SQL:"}),e.jsx("pre",{style:{padding:"10px",backgroundColor:t.bgDark,border:`1px solid ${t.border}`,overflow:"auto",maxHeight:"300px",fontSize:"12px"},children:h})]}),e.jsxs("div",{style:{display:"flex",gap:"10px",justifyContent:"flex-end"},children:[n&&e.jsxs(x,{onClick:S,disabled:C,children:[C?i.loading:i.code," Compile"]}),e.jsxs(x,{onClick:M,disabled:m,children:[m?i.loading:i.save," Save"]})]})]})})})},J=({model:n,onBack:b})=>{const[o,B]=r.useState([]),[j,d]=r.useState([]),[m,v]=r.useState(!1),[h,_]=r.useState(!1),[C,u]=r.useState(null),c=r.useCallback(async()=>{try{v(!0),u(null);const s=await f.getTests(n.model_name);B(s)}catch(s){u(z(s))}finally{v(!1)}},[n.model_name]),g=r.useCallback(async()=>{try{const s=await f.getTestResults(n.model_name);d(s)}catch(s){console.error("Error fetching test results:",s)}},[n.model_name]);r.useEffect(()=>{c(),g()},[c,g]);const M=r.useCallback(async()=>{try{_(!0),u(null);const s=await f.runTests(n.model_name);s.success&&d(s.results),c()}catch(s){u(z(s))}finally{_(!1)}},[n.model_name,c]),S=s=>{switch(s.toLowerCase()){case"pass":return t.green;case"fail":return t.red;case"error":return t.red;case"skipped":return t.gray;default:return t.gray}},T=s=>{switch(s.toLowerCase()){case"pass":return i.check;case"fail":return i.cross;case"error":return i.cross;case"skipped":return i.dash;default:return i.dash}},w=j.slice(0,o.length);return e.jsx("div",{style:{padding:"20px"},children:e.jsxs(A,{children:[e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[e.jsxs("div",{children:[e.jsxs("h2",{style:{color:t.cyan,margin:0,marginBottom:"5px"},children:["TESTS: ",n.model_name]}),e.jsxs("div",{style:{color:t.gray,fontSize:"12px"},children:["Schema: ",n.schema_name," | Materialization: ",n.materialization]})]}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsxs(x,{onClick:M,disabled:h,children:[h?i.loading:i.play," Run All Tests"]}),e.jsxs(x,{onClick:b,children:[i.back," Back"]})]})]}),C&&e.jsx("div",{style:{color:t.red,marginBottom:"15px",padding:"10px",border:`1px solid ${t.red}`},children:C})]}),m?e.jsx("div",{style:{color:t.gray,textAlign:"center",padding:"20px"},children:"Loading tests..."}):o.length===0?e.jsx("div",{style:{color:t.gray,textAlign:"center",padding:"20px"},children:"No tests defined for this model"}):e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:o.map((s,y)=>{const l=w.find(p=>p.test_name===s.test_name);return e.jsx("div",{style:{border:`1px solid ${t.border}`,padding:"15px",backgroundColor:t.bg},children:e.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start",marginBottom:"10px"},children:e.jsxs("div",{style:{flex:1},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"5px"},children:[e.jsx("span",{style:{color:t.cyan,fontWeight:"bold"},children:s.test_name}),e.jsxs("span",{style:{color:t.yellow,fontSize:"12px"},children:["[",s.test_type,"]"]}),s.column_name&&e.jsxs("span",{style:{color:t.gray,fontSize:"12px"},children:["Column: ",s.column_name]}),l&&e.jsxs("span",{style:{color:S(l.status),fontSize:"12px"},children:[T(l.status)," ",l.status.toUpperCase()]}),!s.active&&e.jsx("span",{style:{color:t.gray,fontSize:"12px"},children:"[INACTIVE]"})]}),s.description&&e.jsx("div",{style:{color:t.text,fontSize:"13px",marginBottom:"5px"},children:s.description}),s.test_sql&&e.jsxs("div",{style:{marginTop:"10px"},children:[e.jsx("div",{style:{color:t.gray,fontSize:"11px",marginBottom:"5px"},children:"Test SQL:"}),e.jsx("pre",{style:{padding:"8px",backgroundColor:t.bgDark,border:`1px solid ${t.border}`,fontSize:"11px",overflow:"auto",maxHeight:"100px"},children:s.test_sql})]}),l&&e.jsxs("div",{style:{marginTop:"10px",padding:"10px",backgroundColor:t.bgDark,border:`1px solid ${S(l.status)}`},children:[e.jsxs("div",{style:{color:t.gray,fontSize:"11px",marginBottom:"5px"},children:["Last Run: ",l.created_at?new Date(l.created_at).toLocaleString():"N/A",l.execution_time_seconds!==void 0&&` | Duration: ${l.execution_time_seconds.toFixed(3)}s`,l.rows_affected!==void 0&&` | Rows Affected: ${l.rows_affected}`]}),l.error_message&&e.jsxs("div",{style:{color:t.red,fontSize:"12px",marginTop:"5px"},children:["Error: ",l.error_message]}),l.test_result&&l.test_result.failure_count!==void 0&&e.jsxs("div",{style:{color:t.text,fontSize:"12px",marginTop:"5px"},children:["Failures: ",l.test_result.failure_count]})]})]})})},s.id||y)})})]})})},ae=()=>{const[n,b]=r.useState(""),[o,B]=r.useState(""),[j,d]=r.useState(null),[m,v]=r.useState([]),[h,_]=r.useState(!0),[C,u]=r.useState(!1),[c,g]=r.useState(null),[M,S]=r.useState(null),[T,w]=r.useState("list"),[s,y]=r.useState(null),l=r.useRef(!0),p=r.useCallback(async()=>{if(!l.current)return;const a=Date.now(),k=300;try{_(!0),d(null);const D=await f.getModels(),W=Date.now()-a,H=Math.max(0,k-W);if(await new Promise(L=>setTimeout(L,H)),l.current){let L=D;if(o){const I=K(o,100).toLowerCase();L=D.filter(E=>E.model_name.toLowerCase().includes(I)||E.description&&E.description.toLowerCase().includes(I)||E.schema_name&&E.schema_name.toLowerCase().includes(I))}v(L)}}catch(D){l.current&&d(z(D))}finally{l.current&&_(!1)}},[o]);r.useEffect(()=>(l.current=!0,p(),()=>{l.current=!1}),[p]);const $=r.useCallback(()=>{B(n)},[n]),F=r.useCallback(a=>{a.key==="Enter"&&$()},[$]),q=r.useCallback(async a=>{if(confirm(`Are you sure you want to delete model "${a}"?`))try{await f.deleteModel(a),p()}catch(k){l.current&&d(z(k))}},[p]),R=r.useCallback(a=>{g(a||null),u(!0)},[]),N=r.useCallback(()=>{u(!1),g(null),p()},[p]),O=r.useCallback(async a=>{try{y(a),await f.executeModel(a),p()}catch(k){l.current&&d(z(k))}finally{y(null)}},[p]),Q=r.useCallback(a=>{S(a),w("tests")},[]),V=a=>{if(!a)return t.gray;switch(a.toLowerCase()){case"success":return t.green;case"error":return t.red;case"running":return t.yellow;default:return t.gray}},P=a=>{switch(a){case"table":return t.blue;case"view":return t.cyan;case"incremental":return t.magenta;case"ephemeral":return t.gray;default:return t.white}};return h&&m.length===0?e.jsx(U,{variant:"table"}):T==="tests"&&M?e.jsx(J,{model:M,onBack:()=>{w("list"),S(null)}}):e.jsxs("div",{style:{padding:"20px"},children:[e.jsxs(A,{children:[e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[e.jsx("h2",{style:{color:t.cyan,margin:0},children:"DBT MODELS"}),e.jsxs(x,{onClick:()=>R(),children:[i.plus," New Model"]})]}),e.jsxs("div",{style:{display:"flex",gap:"10px",marginBottom:"15px"},children:[e.jsx("input",{type:"text",placeholder:"Search models...",value:n,onChange:a=>b(a.target.value),onKeyPress:F,style:{flex:1,padding:"8px",backgroundColor:t.bg,color:t.text,border:`1px solid ${t.border}`,fontFamily:"monospace"}}),e.jsxs(x,{onClick:$,children:[i.search," Search"]})]}),j&&e.jsx("div",{style:{color:t.red,marginBottom:"15px",padding:"10px",border:`1px solid ${t.red}`},children:j})]}),h?e.jsx("div",{style:{color:t.gray,textAlign:"center",padding:"20px"},children:"Loading models..."}):m.length===0?e.jsx("div",{style:{color:t.gray,textAlign:"center",padding:"20px"},children:"No models found"}):e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:m.map(a=>e.jsx("div",{style:{border:`1px solid ${t.border}`,padding:"15px",backgroundColor:a.active?t.bg:t.bgDark},children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start",marginBottom:"10px"},children:[e.jsxs("div",{style:{flex:1},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"5px"},children:[e.jsx("span",{style:{color:t.cyan,fontWeight:"bold",fontSize:"16px"},children:a.model_name}),e.jsxs("span",{style:{color:P(a.materialization),fontSize:"12px"},children:["[",a.materialization||"table","]"]}),a.last_run_status&&e.jsxs("span",{style:{color:V(a.last_run_status),fontSize:"12px"},children:["[",a.last_run_status,"]"]}),!a.active&&e.jsx("span",{style:{color:t.gray,fontSize:"12px"},children:"[INACTIVE]"})]}),e.jsxs("div",{style:{color:t.gray,fontSize:"12px",marginBottom:"5px"},children:["Schema: ",a.schema_name,a.database_name&&` | Database: ${a.database_name}`,a.version&&` | Version: ${a.version}`]}),a.description&&e.jsx("div",{style:{color:t.text,fontSize:"13px",marginBottom:"5px"},children:a.description}),a.tags&&a.tags.length>0&&e.jsx("div",{style:{display:"flex",gap:"5px",flexWrap:"wrap",marginBottom:"5px"},children:a.tags.map((k,D)=>e.jsxs("span",{style:{color:t.yellow,fontSize:"11px"},children:["#",k]},D))}),a.last_run_time&&e.jsxs("div",{style:{color:t.gray,fontSize:"11px"},children:["Last run: ",new Date(a.last_run_time).toLocaleString(),a.last_run_rows!==void 0&&` | Rows: ${a.last_run_rows.toLocaleString()}`]})]}),e.jsxs("div",{style:{display:"flex",gap:"5px",flexDirection:"column"},children:[e.jsxs(x,{onClick:()=>O(a.model_name),disabled:s===a.model_name,style:{fontSize:"11px",padding:"5px 10px"},children:[s===a.model_name?i.loading:i.play," Execute"]}),e.jsxs(x,{onClick:()=>Q(a),style:{fontSize:"11px",padding:"5px 10px"},children:[i.check," Tests"]}),e.jsxs(x,{onClick:()=>R(a),style:{fontSize:"11px",padding:"5px 10px"},children:[i.edit," Edit"]}),e.jsxs(x,{onClick:()=>q(a.model_name),style:{fontSize:"11px",padding:"5px 10px",color:t.red},children:[i.delete," Delete"]})]})]})},a.model_name))})]}),C&&e.jsx(G,{model:c,onClose:N})]})};export{ae as default};
