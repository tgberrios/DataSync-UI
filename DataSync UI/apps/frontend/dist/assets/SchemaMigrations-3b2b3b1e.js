import{r as i,j as o,b as e,e as h,aa as V,ab as A,C as Y,t as S}from"./index-f6ac47b8.js";import{A as U}from"./AsciiButton-4907e65e.js";import{S as K}from"./SkeletonLoader-792007e7.js";import{u as X}from"./usePagination-c6b4a268.js";import{u as J}from"./useTableFilters-7bb371e7.js";import{e as T}from"./errorHandler-5ea9ae85.js";import{s as Z}from"./validation-24839588.js";import{A as O}from"./AsciiPanel-5614714e.js";import{C as ee}from"./ConnectionStringSelector-88b65555.js";import"./GCSConnectionConfig-f004c48c.js";const oe=({migrations:l,loading:b,onViewMigration:n,onApplyMigration:x,onRollbackMigration:_,onTestMigration:a})=>{const[C,w]=i.useState(new Set),v=m=>{w(d=>{const t=new Set(d);return t.has(m)?t.delete(m):t.add(m),t})},y=i.useMemo(()=>{const m={};return l.forEach(d=>{const t=d.version||"unversioned";m[t]||(m[t]=[]),m[t].push(d)}),m},[l]),j=m=>{switch(m){case"APPLIED":return e.success;case"PENDING":return e.warning;case"FAILED":return e.danger;case"ROLLED_BACK":return e.muted;default:return e.foreground}},R=m=>{switch(m){case"APPLIED":return"âœ“";case"PENDING":return"â³";case"FAILED":return"âœ—";case"ROLLED_BACK":return"â†©";default:return"?"}};return b?o.jsxs("div",{style:{padding:40,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:[h.blockSemi," Loading migrations..."]}):l.length===0?o.jsxs("div",{style:{padding:40,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:[h.blockSemi," No migrations found. Create your first migration to get started."]}):o.jsx("div",{style:{border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,maxHeight:"70vh",overflowY:"auto"},children:Object.entries(y).map(([m,d])=>o.jsxs("div",{style:{marginBottom:8},children:[o.jsxs("div",{style:{padding:"8px 12px",background:e.background,borderBottom:`1px solid ${e.border}`,fontSize:11,fontWeight:600,color:e.accent,fontFamily:"Consolas"},children:[h.blockSemi," VERSION: ",m," (",d.length," migrations)"]}),d.map(t=>{const c=C.has(t.migration_name);return o.jsxs("div",{style:{borderBottom:`1px solid ${e.border}`},children:[o.jsxs("div",{onClick:()=>v(t.migration_name),style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:12,background:"transparent",transition:"background 0.2s"},onMouseEnter:u=>{u.currentTarget.style.background=e.backgroundSoft},onMouseLeave:u=>{u.currentTarget.style.background="transparent"},children:[o.jsx("span",{style:{fontSize:14,color:e.foreground,fontFamily:"Consolas",minWidth:20},children:c?h.tDown:h.tRight}),o.jsxs("div",{style:{flex:1},children:[o.jsx("div",{style:{fontSize:13,fontWeight:600,color:e.foreground,fontFamily:"Consolas",marginBottom:4},children:t.migration_name}),o.jsxs("div",{style:{fontSize:11,color:e.muted,fontFamily:"Consolas",display:"flex",gap:16,flexWrap:"wrap"},children:[o.jsxs("span",{children:["Version: ",t.version]}),o.jsxs("span",{children:["DB: ",t.db_engine||"N/A"]}),o.jsxs("span",{children:["Created: ",new Date(t.created_at).toLocaleDateString()]})]})]}),o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[o.jsxs("span",{style:{padding:"4px 8px",borderRadius:2,fontSize:10,fontWeight:600,background:j(t.status)+"40",color:j(t.status),fontFamily:"Consolas",border:`1px solid ${j(t.status)}`},children:[R(t.status)," ",t.status]}),o.jsx("button",{onClick:u=>{u.stopPropagation(),n(t)},style:{padding:"4px 8px",border:`1px solid ${e.border}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:10,fontFamily:"Consolas",fontWeight:600},children:"VIEW"})]})]}),c&&o.jsxs("div",{style:{padding:"16px 16px 16px 48px",background:e.background,borderTop:`1px solid ${e.border}`},children:[o.jsx("div",{style:{fontSize:11,color:e.muted,fontFamily:"Consolas",marginBottom:12,lineHeight:1.6},children:t.description||"No description provided."}),o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:12,marginBottom:12},children:[o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4},children:"Checksum"}),o.jsx("div",{style:{fontSize:11,color:e.foreground,fontFamily:"Consolas",wordBreak:"break-all"},children:t.checksum||"N/A"})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4},children:"Created At"}),o.jsx("div",{style:{fontSize:11,color:e.foreground,fontFamily:"Consolas"},children:new Date(t.created_at).toLocaleString()})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4},children:"Last Applied"}),o.jsx("div",{style:{fontSize:11,color:e.foreground,fontFamily:"Consolas"},children:t.last_applied_at?new Date(t.last_applied_at).toLocaleString():"Never"})]})]}),o.jsxs("div",{style:{display:"flex",gap:8,marginTop:12,flexWrap:"wrap"},children:[a&&o.jsx("button",{onClick:u=>{u.stopPropagation(),a(t)},style:{padding:"6px 12px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600},children:"ðŸ§ª TEST"}),t.status!=="APPLIED"&&o.jsx("button",{onClick:u=>{u.stopPropagation();const F=prompt("Enter environment (dev/staging/qa/production):");F&&x(t.migration_name,F)},style:{padding:"6px 12px",border:`1px solid ${e.success}`,borderRadius:2,background:e.success,color:e.background,cursor:"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600},children:"âœ“ APPLY"}),t.status==="APPLIED"&&o.jsx("button",{onClick:u=>{u.stopPropagation();const F=prompt("Enter environment (dev/staging/qa/production):");F&&_(t.migration_name,F)},style:{padding:"6px 12px",border:`1px solid ${e.warning}`,borderRadius:2,background:e.warning,color:e.background,cursor:"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600},children:"â†© ROLLBACK"})]})]})]},t.migration_name)})]},m))})},P=l=>{switch(l){case"PostgreSQL":return"postgresql://username:password@localhost:5432/database_name";case"MariaDB":return"mysql://username:password@localhost:3306/database_name";case"MSSQL":return"mssql://username:password@localhost:1433/database_name";case"MongoDB":return"mongodb://username:password@localhost:27017/database_name?authSource=admin";case"Oracle":return"oracle://username:password@localhost:1521/XE";default:return"postgresql://username:password@localhost:5432/database_name"}},ne=({onClose:l,onSuccess:b})=>{const[n,x]=i.useState({migration_name:"",version:"",description:"",db_engine:"PostgreSQL",forward_sql:"",rollback_sql:"",environment_connections:{dev:"",staging:"",qa:"",production:P("PostgreSQL")}}),[_,a]=i.useState(null),[C,w]=i.useState(!1),[v,y]=i.useState({env:"",testing:!1}),[j,R]=i.useState(!1),[m,d]=i.useState({}),[t,c]=i.useState(null),[u,F]=i.useState("production");i.useEffect(()=>{const r=P(n.db_engine),p=["postgresql://username:password@localhost:5432/database_name","mysql://username:password@localhost:3306/database_name","mssql://username:password@localhost:1433/database_name","mongodb://username:password@localhost:27017/database_name?authSource=admin","oracle://username:password@localhost:1521/XE"];x(f=>{const k={...f.environment_connections};return(!k.production||p.includes(k.production))&&(k.production=r),{...f,environment_connections:k}})},[n.db_engine]);const g=async r=>{const p=n.environment_connections[r];if(!p||p.trim()===""){d(f=>({...f,[r]:{success:!1,message:"Connection string is required"}}));return}y({env:r,testing:!0}),d(f=>({...f,[r]:null})),a(null);try{await V.testConnection(n.db_engine,p),d(f=>({...f,[r]:{success:!0,message:"Connection successful!"}}))}catch(f){d(k=>({...k,[r]:{success:!1,message:T(f)}}))}finally{y({env:"",testing:!1})}},E=async()=>{var p;if(!n.forward_sql||n.forward_sql.trim()===""){c({success:!1,message:"Forward SQL is required"});return}if(!n.rollback_sql||n.rollback_sql.trim()===""){c({success:!1,message:"Rollback SQL is required"});return}const r=n.environment_connections[u];if(!r||r.trim()===""){c({success:!1,message:`Connection string for ${u} is required`});return}R(!0),c(null),a(null);try{const f=await A.testSQL({db_engine:n.db_engine,connection_string:r,forward_sql:n.forward_sql,rollback_sql:n.rollback_sql});c({success:f.success,message:f.message||(f.success?"SQL test successful! Forward and rollback executed correctly.":((p=f.errors)==null?void 0:p.join("; "))||"SQL test failed")})}catch(f){c({success:!1,message:T(f)})}finally{R(!1)}},I=async r=>{if(r.preventDefault(),a(null),!n.migration_name||!n.version||!n.forward_sql){a("Migration name, version, and forward SQL are required");return}if(!n.rollback_sql||n.rollback_sql.trim()===""){a("Rollback SQL is MANDATORY. Every migration must have a rollback strategy.");return}if(!n.environment_connections.production||n.environment_connections.production.trim()===""){a("Production Connection String is MANDATORY.");return}w(!0);try{const p={};Object.entries(n.environment_connections).forEach(([f,k])=>{k&&k.trim()!==""&&(p[f]=k.trim())}),await A.create({...n,environment_connections:p}),b()}catch(p){a(T(p))}finally{w(!1)}};return o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:o.jsx("div",{style:{width:"90%",maxWidth:800,maxHeight:"90vh",overflowY:"auto"},children:o.jsxs(O,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${e.border}`},children:[o.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:e.accent,margin:0,fontFamily:"Consolas"},children:[h.blockFull," CREATE MIGRATION"]}),o.jsx("button",{onClick:l,style:{background:"transparent",border:"none",color:e.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),o.jsx("form",{onSubmit:I,children:o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16},children:[o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Migration Name *"}),o.jsx("input",{type:"text",value:n.migration_name,onChange:r=>x({...n,migration_name:r.target.value}),placeholder:"e.g., add_user_email_column",style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12}})]}),o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Version *"}),o.jsx("input",{type:"text",value:n.version,onChange:r=>x({...n,version:r.target.value}),placeholder:"e.g., 1.0.0",style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12}})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"DB Engine"}),o.jsxs("select",{value:n.db_engine,onChange:r=>x({...n,db_engine:r.target.value}),style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer"},children:[o.jsx("option",{value:"PostgreSQL",children:"PostgreSQL"}),o.jsx("option",{value:"MariaDB",children:"MariaDB"}),o.jsx("option",{value:"MSSQL",children:"MSSQL"}),o.jsx("option",{value:"Oracle",children:"Oracle"}),o.jsx("option",{value:"MongoDB",children:"MongoDB"})]})]})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Description"}),o.jsx("textarea",{value:n.description,onChange:r=>x({...n,description:r.target.value}),placeholder:"Describe what this migration does...",rows:3,style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:12,resize:"vertical"}})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:12,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," ENVIRONMENT CONNECTION STRINGS"]}),["dev","staging","qa","production"].map(r=>{const p=r==="production",f=n.environment_connections[r],k=m[r],D=v.testing&&v.env===r;return o.jsx("div",{style:{marginBottom:16},children:o.jsx(ee,{value:f,onChange:$=>{x(z=>({...z,environment_connections:{...z.environment_connections,[r]:$}})),d(z=>({...z,[r]:void 0}))},dbEngine:n.db_engine,label:`${r.charAt(0).toUpperCase()+r.slice(1)} Connection`,required:p,onTestConnection:()=>g(r),isTesting:D,testResult:k||null})},r)})]}),o.jsxs("div",{children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Forward SQL *"}),o.jsx("textarea",{value:n.forward_sql,onChange:r=>x({...n,forward_sql:r.target.value}),placeholder:"ALTER TABLE users ADD COLUMN email VARCHAR(255);",rows:8,style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,resize:"vertical"}})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:[o.jsx("label",{style:{display:"block",fontSize:11,color:e.muted,fontFamily:"Consolas"},children:"Rollback SQL * (MANDATORY)"}),o.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[o.jsxs("select",{value:u,onChange:r=>F(r.target.value),style:{padding:"6px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,cursor:"pointer"},children:[o.jsx("option",{value:"dev",children:"Test on Dev"}),o.jsx("option",{value:"staging",children:"Test on Staging"}),o.jsx("option",{value:"qa",children:"Test on QA"}),o.jsx("option",{value:"production",children:"Test on Production"})]}),o.jsx("button",{type:"button",onClick:E,disabled:j||!n.forward_sql||!n.rollback_sql||!n.environment_connections[u],style:{padding:"6px 12px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:j||!n.forward_sql||!n.rollback_sql||!n.environment_connections[u]?"not-allowed":"pointer",fontSize:11,fontFamily:"Consolas",fontWeight:600,opacity:j||!n.forward_sql||!n.rollback_sql||!n.environment_connections[u]?.5:1},children:j?"TESTING...":"TEST SQL"})]})]}),o.jsx("textarea",{value:n.rollback_sql,onChange:r=>{x({...n,rollback_sql:r.target.value}),c(null)},placeholder:"ALTER TABLE users DROP COLUMN email;",rows:8,style:{width:"100%",padding:"8px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,resize:"vertical"}}),t&&o.jsxs("div",{style:{marginTop:8,padding:8,background:t.success?e.success+"20":e.danger+"20",border:`1px solid ${t.success?e.success:e.danger}`,borderRadius:2,color:t.success?e.success:e.danger,fontSize:11,fontFamily:"Consolas"},children:[t.success?"âœ“ ":"âœ— ",t.message]})]}),_&&o.jsxs("div",{style:{padding:12,background:e.danger+"20",border:`1px solid ${e.danger}`,borderRadius:2,color:e.danger,fontSize:11,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",_]}),o.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"flex-end",marginTop:8},children:[o.jsx("button",{type:"button",onClick:l,style:{padding:"8px 16px",border:`1px solid ${e.muted}`,borderRadius:2,background:e.muted,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CANCEL"}),o.jsx("button",{type:"submit",disabled:C,style:{padding:"8px 16px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:C?"not-allowed":"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600,opacity:C?.5:1},children:C?"CREATING...":"CREATE MIGRATION"})]})]})})]})})})},te=({migration:l,onClose:b,onApply:n,onRollback:x,onTest:_})=>{const[a,C]=i.useState([]),[w,v]=i.useState(!1),[y,j]=i.useState("dev"),[R,m]=i.useState(null),[d,t]=i.useState(!1);i.useEffect(()=>{c()},[l.migration_name]),i.useEffect(()=>{u()},[y,a]);const c=async()=>{try{v(!0);const g=await A.getHistory(l.migration_name);C(g.history||[])}catch(g){m(T(g))}finally{v(!1)}},u=()=>{const g=a.some(E=>E.environment===y&&E.status==="APPLIED");t(g)},F=g=>{switch(g){case"APPLIED":return e.success;case"PENDING":return e.warning;case"FAILED":return e.danger;case"ROLLED_BACK":return e.muted;default:return e.foreground}};return o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:o.jsx("div",{style:{width:"90%",maxWidth:1e3,maxHeight:"90vh",overflowY:"auto"},children:o.jsxs(O,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${e.border}`},children:[o.jsxs("div",{children:[o.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:e.accent,margin:0,fontFamily:"Consolas"},children:[h.blockFull," MIGRATION DETAILS"]}),o.jsx("p",{style:{fontSize:11,color:e.muted,margin:"4px 0 0 0",fontFamily:"Consolas"},children:l.migration_name})]}),o.jsx("button",{onClick:b,style:{background:"transparent",border:"none",color:e.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:20},children:[o.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:16},children:[o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Version"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas",fontWeight:600},children:l.version})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Status"}),o.jsx("div",{style:{fontSize:12,color:F(l.status),fontFamily:"Consolas",fontWeight:600},children:l.status})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"DB Engine"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas",fontWeight:600},children:l.db_engine||"N/A"})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Created At"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas"},children:new Date(l.created_at).toLocaleString()})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Last Applied"}),o.jsx("div",{style:{fontSize:12,color:e.foreground,fontFamily:"Consolas"},children:l.last_applied_at?new Date(l.last_applied_at).toLocaleString():"Never"})]}),o.jsxs("div",{children:[o.jsx("div",{style:{fontSize:10,color:e.muted,marginBottom:4,fontFamily:"Consolas"},children:"Checksum"}),o.jsx("div",{style:{fontSize:10,color:e.foreground,fontFamily:"Consolas",wordBreak:"break-all"},children:l.checksum||"N/A"})]})]}),l.description&&o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," DESCRIPTION"]}),o.jsx("div",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:12,color:e.foreground,fontFamily:"Consolas",lineHeight:1.6},children:l.description})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," FORWARD SQL"]}),o.jsx("pre",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:11,color:e.foreground,fontFamily:"Consolas",overflowX:"auto",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:l.forward_sql||"N/A"})]}),l.rollback_sql&&o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," ROLLBACK SQL"]}),o.jsx("pre",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:11,color:e.foreground,fontFamily:"Consolas",overflowX:"auto",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:l.rollback_sql})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," ACTIONS"]}),o.jsxs("select",{value:y,onChange:g=>j(g.target.value),style:{padding:"6px 12px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,fontFamily:"Consolas",fontSize:11,cursor:"pointer"},children:[o.jsx("option",{value:"dev",children:"Development"}),o.jsx("option",{value:"staging",children:"Staging"}),o.jsx("option",{value:"qa",children:"QA"}),o.jsx("option",{value:"production",children:"Production"})]})]}),o.jsxs("div",{style:{display:"flex",gap:12},children:[_&&o.jsx("button",{onClick:()=>_(l),style:{padding:"8px 16px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"ðŸ§ª TEST MIGRATION"}),!d&&o.jsxs("button",{onClick:()=>n(l.migration_name,y),style:{padding:"8px 16px",border:`1px solid ${e.success}`,borderRadius:2,background:e.success,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:["âœ“ APPLY TO ",y.toUpperCase()]}),d&&l.rollback_sql&&o.jsxs("button",{onClick:()=>x(l.migration_name,y),style:{padding:"8px 16px",border:`1px solid ${e.warning}`,borderRadius:2,background:e.warning,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:["â†© ROLLBACK FROM ",y.toUpperCase()]})]})]}),o.jsxs("div",{children:[o.jsxs("div",{style:{fontSize:11,color:e.muted,marginBottom:8,fontFamily:"Consolas",fontWeight:600},children:[h.blockSemi," EXECUTION HISTORY"]}),w?o.jsx("div",{style:{padding:20,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:"Loading history..."}):a.length===0?o.jsx("div",{style:{padding:20,textAlign:"center",color:e.muted,fontFamily:"Consolas"},children:"No execution history available"}):o.jsx("div",{style:{border:`1px solid ${e.border}`,borderRadius:2,overflow:"hidden"},children:a.map((g,E)=>o.jsxs("div",{style:{padding:"12px 16px",borderBottom:E<a.length-1?`1px solid ${e.border}`:"none",background:E%2===0?e.background:e.backgroundSoft},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:[o.jsxs("div",{style:{fontSize:12,fontWeight:600,color:e.foreground,fontFamily:"Consolas"},children:[g.environment||"N/A"," - ",g.status||"N/A"]}),o.jsx("div",{style:{fontSize:10,color:e.muted,fontFamily:"Consolas"},children:g.executed_at?new Date(g.executed_at).toLocaleString():"N/A"})]}),g.error_message&&o.jsx("div",{style:{fontSize:10,color:e.danger,fontFamily:"Consolas",marginTop:4,padding:8,background:e.danger+"20",borderRadius:2},children:g.error_message}),g.execution_time_ms&&o.jsxs("div",{style:{fontSize:10,color:e.muted,fontFamily:"Consolas",marginTop:4},children:["Execution time: ",g.execution_time_ms,"ms"]})]},E))})]}),R&&o.jsxs("div",{style:{padding:12,background:e.danger+"20",border:`1px solid ${e.danger}`,borderRadius:2,color:e.danger,fontSize:11,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",R]}),o.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:8},children:o.jsx("button",{onClick:b,style:{padding:"8px 16px",border:`1px solid ${e.border}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLOSE"})})]})]})})})},se=({migration:l,onClose:b,onTestSuccess:n})=>{const[x,_]=i.useState(!1),[a,C]=i.useState(null),[w,v]=i.useState(null),[y,j]=i.useState(""),R=async()=>{var d;try{_(!0),v(null),C(null);const t=await A.testMigration(l.migration_name,{environment:"test",test_schema_prefix:"_migration_test_"});C(t),j(t.test_schema||""),t.success?(n&&n(),alert("âœ… Migration test passed! You can now apply it to production.")):alert(`âŒ Migration test failed: ${((d=t.errors)==null?void 0:d.join(", "))||"Unknown error"}`)}catch(t){v(T(t))}finally{_(!1)}},m=async()=>{if(y)try{await A.cleanupTestSchema(y),j(""),C(null),alert("âœ… Test schema cleaned up successfully")}catch(d){v(T(d))}};return o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:o.jsx("div",{style:{width:"90%",maxWidth:700,maxHeight:"90vh",overflowY:"auto"},children:o.jsxs(O,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,paddingBottom:16,borderBottom:`2px solid ${e.border}`},children:[o.jsxs("div",{children:[o.jsxs("h2",{style:{fontSize:18,fontWeight:700,color:e.accent,margin:0,fontFamily:"Consolas"},children:[h.blockFull," TEST MIGRATION"]}),o.jsx("p",{style:{fontSize:11,color:e.muted,margin:"4px 0 0 0",fontFamily:"Consolas"},children:l.migration_name})]}),o.jsx("button",{onClick:b,style:{background:"transparent",border:"none",color:e.foreground,fontSize:20,cursor:"pointer",padding:"0 8px"},children:"Ã—"})]}),o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16},children:[o.jsxs("div",{style:{padding:12,background:e.backgroundSoft,borderRadius:2,border:`1px solid ${e.border}`,fontSize:11,fontFamily:"Consolas",lineHeight:1.6},children:[o.jsxs("div",{style:{fontWeight:600,marginBottom:8,color:e.foreground},children:[h.blockSemi," How it works:"]}),o.jsxs("ul",{style:{margin:0,paddingLeft:20,color:e.muted},children:[o.jsx("li",{children:"Creates a temporary test schema"}),o.jsx("li",{children:"Executes the forward SQL in the test schema"}),o.jsx("li",{children:"Validates that the migration works correctly"}),o.jsx("li",{children:"Tests the rollback SQL"}),o.jsx("li",{children:"Cleans up the test schema automatically"})]})]}),w&&o.jsxs("div",{style:{padding:12,background:e.danger+"20",border:`1px solid ${e.danger}`,borderRadius:2,color:e.danger,fontSize:11,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",w]}),a&&o.jsxs("div",{style:{padding:12,background:a.success?e.success+"20":e.danger+"20",border:`1px solid ${a.success?e.success:e.danger}`,borderRadius:2,fontSize:11,fontFamily:"Consolas"},children:[o.jsx("div",{style:{fontWeight:600,marginBottom:8,color:a.success?e.success:e.danger},children:a.success?"âœ“ TEST PASSED":"âœ— TEST FAILED"}),a.test_schema&&o.jsxs("div",{style:{color:e.muted,marginBottom:4},children:["Test Schema: ",a.test_schema]}),a.execution_time_ms&&o.jsxs("div",{style:{color:e.muted,marginBottom:4},children:["Execution Time: ",a.execution_time_ms,"ms"]}),a.errors&&a.errors.length>0&&o.jsxs("div",{style:{marginTop:8},children:[o.jsx("div",{style:{fontWeight:600,marginBottom:4,color:e.danger},children:"Errors:"}),a.errors.map((d,t)=>o.jsxs("div",{style:{color:e.danger,marginLeft:12},children:["â€¢ ",d]},t))]})]}),o.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"flex-end"},children:[y&&o.jsx("button",{onClick:m,style:{padding:"8px 16px",border:`1px solid ${e.warning}`,borderRadius:2,background:e.warning,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLEANUP TEST SCHEMA"}),o.jsx("button",{onClick:R,disabled:x,style:{padding:"8px 16px",border:`1px solid ${e.accent}`,borderRadius:2,background:e.accent,color:e.background,cursor:x?"not-allowed":"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600,opacity:x?.5:1},children:x?"TESTING...":"RUN TEST"}),o.jsx("button",{onClick:b,style:{padding:"8px 16px",border:`1px solid ${e.border}`,borderRadius:2,background:e.backgroundSoft,color:e.foreground,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"CLOSE"})]})]})]})})})},xe=()=>{const{setPage:l}=X(1,20),{filters:b,setFilter:n}=J({status:"",environment:"",db_engine:""}),[x,_]=i.useState(""),[a,C]=i.useState(""),[w,v]=i.useState(null),[y,j]=i.useState([]),[R,m]=i.useState(!0),[d,t]=i.useState(!1),[c,u]=i.useState(null),[F,g]=i.useState(!1),[E,I]=i.useState(!1);i.useState("migrations");const r=i.useRef(!0);i.useEffect(()=>(r.current=!0,()=>{r.current=!1}),[]);const p=i.useCallback(async()=>{if(!r.current)return;const s=Date.now(),B=300;try{m(!0),v(null);const M={page:1,limit:1e4,search:Z(a,100)};b.status&&(M.status=b.status),b.environment&&(M.environment=b.environment),b.db_engine&&(M.db_engine=b.db_engine);const W=(await A.getAll(M)).migrations||[],Q=Date.now()-s,H=Math.max(0,B-Q);await new Promise(G=>setTimeout(G,H)),r.current&&j(W)}catch(L){console.error("Error in fetchAllMigrations:",L),r.current&&v(T(L))}finally{r.current&&m(!1)}},[a,b]);i.useEffect(()=>{p()},[p]);const f=i.useCallback(()=>{C(x),l(1)},[x,l]),k=i.useCallback(()=>{t(!0)},[]),D=i.useCallback(()=>{t(!1),p()},[p]),$=i.useCallback(s=>{u(s),g(!0)},[]),z=i.useCallback(s=>{u(s),I(!0)},[]),q=i.useCallback(async(s,B)=>{try{await A.apply(s,B),alert("âœ… Migration applied successfully"),p(),(c==null?void 0:c.migration_name)===s&&g(!1)}catch(L){r.current&&v(T(L))}},[p,c]),N=i.useCallback(async(s,B)=>{const L=`âš ï¸ WARNING: This will rollback migration "${s}" in environment "${B}".

This action cannot be undone. Are you absolutely sure?`;if(confirm(L))try{await A.rollback(s,B),alert("âœ… Migration rolled back successfully"),p(),(c==null?void 0:c.migration_name)===s&&g(!1)}catch(M){r.current&&v(T(M))}},[p,c]);return R&&y.length===0?o.jsx(K,{variant:"table"}):o.jsxs(Y,{children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:S.spacing.lg,paddingBottom:S.spacing.md,borderBottom:`2px solid ${e.accent}`},children:[o.jsxs("h1",{style:{fontSize:14,fontWeight:600,margin:0,color:e.foreground,textTransform:"uppercase",fontFamily:"Consolas"},children:[o.jsx("span",{style:{color:e.accent,marginRight:S.spacing.sm},children:h.blockFull}),"SCHEMA MIGRATIONS"]}),o.jsx(U,{label:`${h.blockSemi} CREATE MIGRATION`,onClick:k})]}),o.jsxs("div",{style:{display:"flex",gap:S.spacing.sm,marginBottom:S.spacing.md,flexWrap:"wrap",alignItems:"center"},children:[o.jsx("input",{type:"text",value:x,onChange:s=>_(s.target.value),onKeyPress:s=>s.key==="Enter"&&f(),placeholder:"Search migrations...",style:{flex:1,minWidth:200,padding:`${S.spacing.sm} ${S.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,outline:"none",transition:"border-color 0.15s ease"},onFocus:s=>{s.target.style.borderColor=e.accent,s.target.style.outline=`2px solid ${e.accent}`,s.target.style.outlineOffset="2px"},onBlur:s=>{s.target.style.borderColor=e.border,s.target.style.outline="none"}}),o.jsx("button",{onClick:f,style:{minWidth:100,padding:`${S.spacing.sm} ${S.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.accent,color:e.background,cursor:"pointer",fontSize:12,fontFamily:"Consolas",fontWeight:600},children:"SEARCH"}),o.jsxs("select",{value:b.status,onChange:s=>{n("status",s.target.value),l(1)},style:{padding:`${S.spacing.sm} ${S.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer",outline:"none",transition:"border-color 0.15s ease"},onFocus:s=>{s.target.style.borderColor=e.accent,s.target.style.outline=`2px solid ${e.accent}`,s.target.style.outlineOffset="2px"},onBlur:s=>{s.target.style.borderColor=e.border,s.target.style.outline="none"},children:[o.jsx("option",{value:"",children:"All Status"}),o.jsx("option",{value:"PENDING",children:"Pending"}),o.jsx("option",{value:"APPLIED",children:"Applied"}),o.jsx("option",{value:"FAILED",children:"Failed"}),o.jsx("option",{value:"ROLLED_BACK",children:"Rolled Back"})]}),o.jsxs("select",{value:b.environment,onChange:s=>{n("environment",s.target.value),l(1)},style:{padding:`${S.spacing.sm} ${S.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer",outline:"none",transition:"border-color 0.15s ease"},onFocus:s=>{s.target.style.borderColor=e.accent,s.target.style.outline=`2px solid ${e.accent}`,s.target.style.outlineOffset="2px"},onBlur:s=>{s.target.style.borderColor=e.border,s.target.style.outline="none"},children:[o.jsx("option",{value:"",children:"All Environments"}),o.jsx("option",{value:"dev",children:"Development"}),o.jsx("option",{value:"staging",children:"Staging"}),o.jsx("option",{value:"qa",children:"QA"}),o.jsx("option",{value:"production",children:"Production"})]}),o.jsxs("select",{value:b.db_engine,onChange:s=>{n("db_engine",s.target.value),l(1)},style:{padding:`${S.spacing.sm} ${S.spacing.md}`,border:`1px solid ${e.border}`,borderRadius:2,background:e.background,color:e.foreground,fontFamily:"Consolas",fontSize:12,cursor:"pointer",outline:"none",transition:"border-color 0.15s ease"},onFocus:s=>{s.target.style.borderColor=e.accent,s.target.style.outline=`2px solid ${e.accent}`,s.target.style.outlineOffset="2px"},onBlur:s=>{s.target.style.borderColor=e.border,s.target.style.outline="none"},children:[o.jsx("option",{value:"",children:"All DB Engines"}),o.jsx("option",{value:"PostgreSQL",children:"PostgreSQL"}),o.jsx("option",{value:"MariaDB",children:"MariaDB"}),o.jsx("option",{value:"MSSQL",children:"MSSQL"}),o.jsx("option",{value:"Oracle",children:"Oracle"}),o.jsx("option",{value:"MongoDB",children:"MongoDB"})]})]}),w&&o.jsxs("div",{style:{padding:S.spacing.sm,marginBottom:S.spacing.md,background:e.backgroundSoft,border:`1px solid ${e.border}`,borderRadius:2,color:e.foreground,fontSize:12,fontFamily:"Consolas"},children:[h.blockFull," ERROR: ",w]}),o.jsx(oe,{migrations:y,loading:R,onViewMigration:$,onApplyMigration:q,onRollbackMigration:N,onTestMigration:z}),d&&o.jsx(ne,{onClose:()=>t(!1),onSuccess:D}),F&&c&&o.jsx(te,{migration:c,onClose:()=>{g(!1),u(null)},onApply:q,onRollback:N,onTest:z}),E&&c&&o.jsx(se,{migration:c,onClose:()=>{I(!1),u(null)},onTestSuccess:()=>{I(!1),p()}})]})};export{xe as default};
